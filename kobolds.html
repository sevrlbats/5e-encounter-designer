<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2d6 Kobolds - 5e Encounter Designer</title>
    <style>
        :root {
            --parchment: #f4e8c1;
            --parchment-dark: #e8d5a3;
            --ink: #2c1810;
            --ink-light: #5c4033;
            --accent-red: #8b1a1a;
            --accent-gold: #b8860b;
            --accent-green: #2d5a1e;
            --border-dark: #3c2415;
            --shadow: rgba(44, 24, 16, 0.3);
            --low: #2d6a2d;
            --moderate: #b8860b;
            --high: #8b1a1a;
            --card-bg: #faf6ee;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', 'Georgia', serif;
            background: #2c1810;
            color: var(--ink);
            min-height: 100vh;
        }

        /* ===== HEADER ===== */
        header {
            background: linear-gradient(135deg, #1a0e08, #3c2415, #1a0e08);
            border-bottom: 3px solid var(--accent-gold);
            padding: 16px 24px;
            display: flex;
            align-items: center;
            gap: 16px;
        }
        header h1 {
            color: var(--parchment);
            font-size: 1.6rem;
            font-variant: small-caps;
            letter-spacing: 2px;
            text-shadow: 1px 1px 4px rgba(0,0,0,0.5);
        }
        header .subtitle {
            color: var(--accent-gold);
            font-size: 0.85rem;
            font-style: italic;
        }
        .header-promo {
            flex: 1;
            text-align: center;
            color: var(--parchment);
            text-decoration: none;
            font-size: 0.7rem;
            opacity: 0.6;
            transition: opacity 0.2s;
            white-space: nowrap;
        }
        .header-promo:hover {
            opacity: 1;
        }
        .header-promo strong {
            color: var(--accent-gold);
        }
        .header-buttons {
            margin-left: 0;
            display: flex;
            gap: 8px;
        }
        .header-btn {
            background: transparent;
            color: var(--parchment);
            border: 2px solid var(--accent-gold);
            padding: 6px 14px;
            border-radius: 4px;
            font-family: inherit;
            font-size: 0.75rem;
            font-variant: small-caps;
            font-weight: bold;
            letter-spacing: 0.5px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .header-btn:hover {
            background: var(--accent-gold);
            color: #1a0e08;
        }
        .header-btn-homebrew {
            background: #d4700a;
            color: #fff;
            border-color: #fff;
        }
        .header-btn-homebrew:hover {
            background: #b85e08;
            color: #fff;
        }

        /* ===== MAIN LAYOUT ===== */
        .app-container {
            display: grid;
            grid-template-columns: 340px 1fr 360px;
            gap: 0;
            height: calc(100vh - 70px);
        }

        /* ===== PANELS ===== */
        .panel {
            background: var(--parchment);
            overflow-y: auto;
            padding: 16px;
        }
        .panel-header {
            font-variant: small-caps;
            font-size: 1.1rem;
            color: var(--accent-red);
            border-bottom: 2px solid var(--accent-red);
            padding-bottom: 6px;
            margin-bottom: 12px;
            letter-spacing: 1px;
        }

        /* ===== LEFT PANEL - PARTY CONFIG ===== */
        .party-panel {
            border-right: 3px solid var(--border-dark);
            background: linear-gradient(180deg, var(--parchment) 0%, var(--parchment-dark) 100%);
        }

        .config-row {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
        }
        .config-row .config-group {
            flex: 1;
            margin-bottom: 0;
        }
        .config-group {
            margin-bottom: 16px;
        }
        .config-group label {
            display: block;
            font-weight: bold;
            font-size: 0.85rem;
            margin-bottom: 4px;
            color: var(--ink-light);
            font-variant: small-caps;
            letter-spacing: 0.5px;
        }
        .config-row {
            display: flex;
            gap: 12px;
            align-items: center;
        }
        .config-group input[type="number"],
        .config-group select {
            width: 100%;
            padding: 8px 10px;
            border: 2px solid var(--border-dark);
            border-radius: 4px;
            background: var(--card-bg);
            font-family: inherit;
            font-size: 0.95rem;
            color: var(--ink);
        }
        .config-group select {
            cursor: pointer;
        }
        .config-group input:focus,
        .config-group select:focus {
            outline: none;
            border-color: var(--accent-gold);
            box-shadow: 0 0 6px rgba(184,134,11,0.3);
        }

        /* XP Budget Display */
        .budget-display {
            background: linear-gradient(135deg, #1a0e08, #2c1810);
            color: var(--parchment);
            border-radius: 6px;
            padding: 14px;
            margin-bottom: 16px;
            border: 2px solid var(--accent-gold);
        }
        .budget-display .budget-title {
            font-variant: small-caps;
            font-size: 0.8rem;
            color: var(--accent-gold);
            letter-spacing: 1px;
            margin-bottom: 8px;
        }
        .budget-numbers {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }
        .budget-item {
            text-align: center;
        }
        .budget-item .value {
            font-size: 1.4rem;
            font-weight: bold;
            color: var(--accent-gold);
        }
        .budget-item .label {
            font-size: 0.7rem;
            color: #bbb;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .budget-bar-container {
            margin-top: 10px;
        }
        .budget-bar-bg {
            height: 12px;
            background: #1a0e08;
            border-radius: 6px;
            overflow: hidden;
            border: 1px solid var(--accent-gold);
        }
        .budget-bar-fill {
            height: 100%;
            border-radius: 6px;
            transition: width 0.3s ease, background-color 0.3s ease;
        }
        .budget-bar-label {
            font-size: 0.7rem;
            color: #bbb;
            text-align: center;
            margin-top: 3px;
        }

        /* Difficulty Selector */
        .difficulty-selector {
            display: flex;
            gap: 0;
            margin-bottom: 16px;
        }
        .diff-btn {
            flex: 1;
            padding: 10px 8px;
            border: 2px solid var(--border-dark);
            background: var(--card-bg);
            cursor: pointer;
            font-family: inherit;
            font-size: 0.8rem;
            font-variant: small-caps;
            font-weight: bold;
            letter-spacing: 0.5px;
            transition: all 0.2s;
            text-align: center;
        }
        .diff-btn:first-child { border-radius: 6px 0 0 6px; }
        .diff-btn:last-child { border-radius: 0 6px 6px 0; }
        .diff-btn:not(:last-child) { border-right: none; }
        .diff-btn:hover { background: var(--parchment-dark); }
        .diff-btn.active-low {
            background: var(--low); color: white;
            border-color: var(--low);
        }
        .diff-btn.active-moderate {
            background: var(--moderate); color: white;
            border-color: var(--moderate);
        }
        .diff-btn.active-high {
            background: var(--high); color: white;
            border-color: var(--high);
        }

        /* Encounter summary in left panel */
        .encounter-summary {
            border-top: 2px solid var(--border-dark);
            padding-top: 12px;
            margin-top: 12px;
        }
        .encounter-summary h3 {
            font-variant: small-caps;
            font-size: 0.95rem;
            color: var(--accent-red);
            margin-bottom: 8px;
        }
        .encounter-monster-list {
            list-style: none;
        }
        .encounter-monster-list li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 8px;
            border-bottom: 1px solid var(--parchment-dark);
            font-size: 0.85rem;
        }
        .encounter-monster-list li:hover {
            background: var(--parchment-dark);
        }
        .monster-count-controls {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .monster-count-controls button {
            width: 22px;
            height: 22px;
            border: 1px solid var(--border-dark);
            border-radius: 3px;
            background: var(--card-bg);
            cursor: pointer;
            font-weight: bold;
            font-size: 0.8rem;
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .monster-count-controls button:hover { background: var(--parchment-dark); }
        .monster-count-controls .count {
            min-width: 20px;
            text-align: center;
            font-weight: bold;
        }
        .monster-xp-cost {
            font-size: 0.75rem;
            color: var(--ink-light);
        }
        .encounter-monster-info {
            cursor: pointer;
            transition: color 0.15s;
        }
        .encounter-monster-info:hover {
            color: var(--accent-red);
        }
        .encounter-monster-info:hover .encounter-monster-name {
            text-decoration: underline;
        }
        .edit-encounter-monster {
            color: var(--accent-gold);
            cursor: pointer;
            border: none;
            background: none;
            font-size: 0.85rem;
            padding: 0 3px;
        }
        .edit-encounter-monster:hover {
            color: var(--ink);
        }
        .remove-monster {
            color: var(--accent-red);
            cursor: pointer;
            font-weight: bold;
            border: none;
            background: none;
            font-size: 1rem;
            padding: 0 4px;
        }

        .clear-encounter-btn,
        .print-cards-btn {
            width: 100%;
            padding: 10px;
            border: 2px solid var(--border-dark);
            border-radius: 6px;
            cursor: pointer;
            font-family: inherit;
            font-size: 0.85rem;
            font-variant: small-caps;
            font-weight: bold;
            letter-spacing: 1px;
            margin-top: 8px;
            transition: all 0.2s;
        }
        .clear-encounter-btn {
            background: var(--card-bg);
            color: var(--accent-red);
        }
        .clear-encounter-btn:hover { background: #f0d0d0; }
        .print-cards-btn {
            background: var(--accent-red);
            color: var(--parchment);
            border-color: var(--accent-red);
        }
        .print-cards-btn:hover { background: #a02020; }

        /* ===== CENTER PANEL - MONSTER BROWSER ===== */
        .monster-panel {
            background: var(--parchment);
        }

        .search-bar {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }
        .search-bar input {
            flex: 1;
            padding: 8px 12px;
            border: 2px solid var(--border-dark);
            border-radius: 6px;
            background: var(--card-bg);
            font-family: inherit;
            font-size: 0.9rem;
        }
        .search-bar input:focus {
            outline: none;
            border-color: var(--accent-gold);
            box-shadow: 0 0 6px rgba(184,134,11,0.3);
        }

        .filter-row {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }
        .filter-row select {
            padding: 6px 8px;
            border: 2px solid var(--border-dark);
            border-radius: 4px;
            background: var(--card-bg);
            font-family: inherit;
            font-size: 0.8rem;
            cursor: pointer;
        }
        .filter-row select:focus {
            outline: none;
            border-color: var(--accent-gold);
        }
        .monster-count-label {
            margin-left: auto;
            font-size: 0.8rem;
            color: var(--ink-light);
            align-self: center;
            font-style: italic;
        }

        /* Monster Grid */
        .monster-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 10px;
            max-height: calc(100vh - 230px);
            overflow-y: auto;
            padding-right: 4px;
        }
        .monster-grid::-webkit-scrollbar { width: 8px; }
        .monster-grid::-webkit-scrollbar-track { background: var(--parchment-dark); border-radius: 4px; }
        .monster-grid::-webkit-scrollbar-thumb { background: var(--border-dark); border-radius: 4px; }

        .monster-card {
            background: var(--card-bg);
            border: 2px solid var(--border-dark);
            border-radius: 6px;
            padding: 10px 12px;
            cursor: pointer;
            transition: all 0.15s;
            position: relative;
        }
        .monster-card:hover {
            border-color: var(--accent-gold);
            box-shadow: 0 2px 8px var(--shadow);
            transform: translateY(-1px);
        }
        .monster-card .mc-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 4px;
        }
        .monster-card .mc-name {
            font-weight: bold;
            font-size: 0.9rem;
            color: var(--accent-red);
        }
        .monster-card .mc-cr {
            background: var(--border-dark);
            color: var(--parchment);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: bold;
            white-space: nowrap;
        }
        .monster-card .mc-meta {
            font-size: 0.75rem;
            color: var(--ink-light);
            font-style: italic;
            margin-bottom: 6px;
        }
        .monster-card .mc-stats {
            display: flex;
            gap: 6px;
            font-size: 0.72rem;
            flex-wrap: wrap;
        }
        .monster-card .mc-stat {
            background: var(--parchment-dark);
            padding: 2px 6px;
            border-radius: 3px;
        }
        .monster-card .mc-stat strong { color: var(--accent-red); }
        .monster-card .mc-add {
            position: absolute;
            bottom: 8px;
            right: 8px;
            width: 26px;
            height: 26px;
            border-radius: 50%;
            border: 2px solid var(--accent-green);
            background: white;
            color: var(--accent-green);
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s;
            line-height: 1;
        }
        .monster-card .mc-add:hover {
            background: var(--accent-green);
            color: white;
        }

        /* ===== RIGHT PANEL - MONSTER DETAIL ===== */
        .detail-panel {
            border-left: 3px solid var(--border-dark);
            background: linear-gradient(180deg, var(--parchment) 0%, var(--parchment-dark) 100%);
        }
        .detail-placeholder {
            text-align: center;
            padding: 40px 20px;
            color: var(--ink-light);
            font-style: italic;
        }

        .stat-block {
            font-size: 0.82rem;
        }
        .stat-block .sb-name {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--accent-red);
            margin-bottom: 2px;
        }
        .stat-block .sb-meta {
            font-style: italic;
            color: var(--ink-light);
            font-size: 0.8rem;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--accent-red);
        }
        .sb-combat-line {
            display: flex;
            gap: 16px;
            margin-bottom: 3px;
        }
        .sb-combat-line strong {
            color: var(--ink);
        }
        .sb-divider {
            border: none;
            border-top: 1px solid var(--accent-red);
            margin: 8px 0;
            opacity: 0.4;
        }
        .ability-scores {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 4px;
            text-align: center;
            margin: 8px 0;
            padding: 8px 4px;
            background: var(--card-bg);
            border-radius: 4px;
            border: 1px solid var(--parchment-dark);
        }
        .ability-scores .as-label {
            font-weight: bold;
            font-size: 0.7rem;
            color: var(--accent-red);
            text-transform: uppercase;
        }
        .ability-scores .as-score {
            font-size: 0.85rem;
            font-weight: bold;
        }
        .ability-scores .as-mod {
            font-size: 0.7rem;
            color: var(--ink-light);
        }
        .sb-section-title {
            font-variant: small-caps;
            font-weight: bold;
            color: var(--accent-red);
            font-size: 0.85rem;
            margin-top: 10px;
            margin-bottom: 4px;
            border-bottom: 1px solid var(--accent-red);
            padding-bottom: 2px;
        }
        .sb-trait {
            margin-bottom: 6px;
        }
        .sb-trait .trait-name {
            font-weight: bold;
            font-style: italic;
        }
        .sb-info-line {
            margin-bottom: 3px;
        }
        .sb-info-line strong {
            color: var(--ink);
        }
        .sb-add-btn {
            width: 100%;
            padding: 10px;
            margin-top: 12px;
            background: var(--accent-green);
            color: white;
            border: none;
            border-radius: 6px;
            font-family: inherit;
            font-size: 0.9rem;
            font-variant: small-caps;
            font-weight: bold;
            letter-spacing: 1px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .sb-add-btn:hover { background: #3a7a28; }

        /* ===== HOMEBREW VISUAL DISTINCTION ===== */
        .monster-card.homebrew-card {
            border: 2px dashed var(--accent-gold);
        }
        .monster-card.homebrew-card:hover {
            border-color: var(--accent-gold);
        }
        .hb-badge {
            display: inline-block;
            background: var(--accent-gold);
            color: #1a0e08;
            font-size: 0.55rem;
            font-weight: bold;
            padding: 1px 5px;
            border-radius: 3px;
            margin-left: 5px;
            vertical-align: middle;
            letter-spacing: 0.5px;
        }
        .sb-homebrew-label {
            font-size: 0.72rem;
            color: var(--accent-gold);
            font-style: italic;
            margin-bottom: 4px;
        }
        .sb-homebrew-actions {
            display: flex;
            gap: 6px;
            margin-top: 8px;
        }
        .sb-homebrew-actions button {
            flex: 1;
            padding: 8px;
            border: 2px solid;
            border-radius: 6px;
            cursor: pointer;
            font-family: inherit;
            font-size: 0.8rem;
            font-variant: small-caps;
            font-weight: bold;
            letter-spacing: 0.5px;
            transition: all 0.2s;
        }
        .btn-edit-hb {
            background: var(--card-bg);
            color: var(--accent-gold);
            border-color: var(--accent-gold);
        }
        .btn-edit-hb:hover { background: #fdf5e6; }
        .btn-delete-hb {
            background: var(--card-bg);
            color: var(--accent-red);
            border-color: var(--accent-red);
        }
        .btn-delete-hb:hover { background: #f8d7da; }
        .btn-save-hb {
            background: var(--card-bg);
            color: var(--accent-gold);
            border-color: var(--accent-gold);
        }
        .btn-save-hb:hover { background: #fdf5e6; }

        .homebrew-count-label {
            font-size: 0.75rem;
            color: var(--ink-light);
            font-style: italic;
            margin-bottom: 8px;
        }
        .hb-btn {
            width: 100%;
            padding: 8px;
            border: 2px solid var(--accent-gold);
            border-radius: 6px;
            cursor: pointer;
            font-family: inherit;
            font-size: 0.8rem;
            font-variant: small-caps;
            font-weight: bold;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
            transition: all 0.2s;
            background: var(--card-bg);
            color: var(--accent-gold);
        }
        .hb-btn:hover { background: #fdf5e6; }
        .hb-btn-primary {
            background: var(--accent-gold);
            color: #1a0e08;
        }
        .hb-btn-primary:hover { background: #d4a017; }

        /* Homebrew Manager List */
        .hb-manager-entry {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 8px;
            border-bottom: 1px solid var(--border-light);
        }
        .hb-manager-entry:last-child { border-bottom: none; }
        .hb-manager-name {
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: bold;
            color: var(--ink);
        }
        .hb-manager-name:hover { color: var(--accent-gold); }
        .hb-manager-actions {
            display: flex;
            gap: 4px;
        }
        .hb-manager-edit, .hb-manager-delete {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            padding: 2px 6px;
            border-radius: 3px;
            transition: all 0.15s;
        }
        .hb-manager-edit {
            color: var(--accent-gold);
        }
        .hb-manager-edit:hover {
            background: var(--accent-gold);
            color: #1a0e08;
        }
        .hb-manager-delete {
            color: var(--accent-red);
            font-size: 1.2rem;
        }
        .hb-manager-delete:hover {
            background: var(--accent-red);
            color: #fff;
        }

        /* ===== HOMEBREW EDITOR MODAL ===== */
        .hb-modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.6);
            z-index: 1100;
            justify-content: center;
            align-items: flex-start;
            padding: 20px;
            overflow-y: auto;
        }
        .hb-modal-overlay.active {
            display: flex;
        }
        .hb-modal {
            background: var(--parchment);
            border: 3px solid var(--accent-gold);
            border-radius: 10px;
            width: 100%;
            max-width: 750px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 20px 24px;
            margin: auto 0;
        }
        .hb-modal h2 {
            font-variant: small-caps;
            color: var(--accent-gold);
            font-size: 1.3rem;
            margin-bottom: 16px;
            border-bottom: 2px solid var(--accent-gold);
            padding-bottom: 8px;
        }
        .hb-form-section {
            margin-bottom: 16px;
        }
        .hb-form-section h3 {
            font-variant: small-caps;
            color: var(--accent-red);
            font-size: 0.95rem;
            margin-bottom: 8px;
            border-bottom: 1px solid var(--accent-red);
            padding-bottom: 4px;
        }
        .hb-form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }
        .hb-form-grid.three-col {
            grid-template-columns: 1fr 1fr 1fr;
        }
        .hb-form-grid.six-col {
            grid-template-columns: repeat(6, 1fr);
        }
        .hb-form-field {
            display: flex;
            flex-direction: column;
        }
        .hb-form-field.full-width {
            grid-column: 1 / -1;
        }
        .hb-form-field label {
            font-size: 0.75rem;
            font-weight: bold;
            color: var(--ink-light);
            font-variant: small-caps;
            margin-bottom: 3px;
        }
        .hb-form-field input,
        .hb-form-field select,
        .hb-form-field textarea {
            padding: 6px 8px;
            border: 2px solid var(--border-dark);
            border-radius: 4px;
            background: var(--card-bg);
            font-family: inherit;
            font-size: 0.85rem;
            color: var(--ink);
        }
        .hb-form-field input:focus,
        .hb-form-field select:focus,
        .hb-form-field textarea:focus {
            outline: none;
            border-color: var(--accent-gold);
            box-shadow: 0 0 4px rgba(184,134,11,0.3);
        }
        .hb-form-field textarea {
            min-height: 50px;
            resize: vertical;
        }
        .hb-dynamic-list {
            margin-top: 4px;
        }
        .hb-dynamic-entry {
            display: flex;
            gap: 6px;
            margin-bottom: 6px;
            align-items: flex-start;
        }
        .hb-dynamic-entry input {
            width: 160px;
            padding: 5px 7px;
            border: 2px solid var(--border-dark);
            border-radius: 4px;
            background: var(--card-bg);
            font-family: inherit;
            font-size: 0.8rem;
        }
        .hb-dynamic-entry textarea {
            flex: 1;
            padding: 5px 7px;
            border: 2px solid var(--border-dark);
            border-radius: 4px;
            background: var(--card-bg);
            font-family: inherit;
            font-size: 0.8rem;
            min-height: 36px;
            resize: vertical;
        }
        .hb-dynamic-entry .hb-remove-entry {
            background: none;
            border: none;
            color: var(--accent-red);
            font-size: 1.1rem;
            cursor: pointer;
            padding: 4px;
            line-height: 1;
        }
        .hb-add-entry-btn {
            background: var(--card-bg);
            border: 1px dashed var(--accent-gold);
            border-radius: 4px;
            padding: 4px 10px;
            cursor: pointer;
            font-family: inherit;
            font-size: 0.75rem;
            color: var(--accent-gold);
            font-weight: bold;
        }
        .hb-add-entry-btn:hover { background: #fdf5e6; }
        .hb-modal-actions {
            display: flex;
            gap: 10px;
            margin-top: 16px;
            padding-top: 12px;
            border-top: 2px solid var(--accent-gold);
        }
        .hb-modal-actions button {
            flex: 1;
            padding: 10px;
            border: 2px solid;
            border-radius: 6px;
            cursor: pointer;
            font-family: inherit;
            font-size: 0.9rem;
            font-variant: small-caps;
            font-weight: bold;
            letter-spacing: 1px;
            transition: all 0.2s;
        }
        .hb-save-btn {
            background: var(--accent-gold);
            color: #1a0e08;
            border-color: var(--accent-gold);
        }
        .hb-save-btn:hover { background: #d4a017; }
        .hb-cancel-btn {
            background: var(--card-bg);
            color: var(--ink-light);
            border-color: var(--border-dark);
        }
        .hb-cancel-btn:hover { background: var(--parchment-dark); }

        /* ===== SOURCE FILTER ===== */
        .source-filter-row {
            margin-bottom: 0;
        }

        /* ===== CLONE BUTTON ===== */
        .panel-header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid var(--accent-red);
            padding-bottom: 6px;
            margin-bottom: 12px;
        }
        .panel-header-row .panel-header {
            border-bottom: none;
            padding-bottom: 0;
            margin-bottom: 0;
        }
        .stat-block-btn {
            padding: 4px 12px;
            background: var(--card-bg);
            color: var(--accent-gold);
            border: 2px solid var(--accent-gold);
            border-radius: 4px;
            cursor: pointer;
            font-family: inherit;
            font-size: 0.72rem;
            font-variant: small-caps;
            font-weight: bold;
            letter-spacing: 0.5px;
            transition: all 0.2s;
        }
        .stat-block-btn:hover {
            background: var(--accent-gold);
            color: #1a0e08;
        }
        .clone-btn {
            display: none;
        }
        .clone-btn.visible {
            display: inline-block;
        }
        .add-new-btn {
            background: var(--accent-red);
            color: #d4700a;
            border-color: #d4700a;
        }
        .add-new-btn:hover {
            background: #d4700a;
            color: #fff;
        }

        /* ===== SETTINGS & ABOUT MODALS ===== */
        .small-modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1100;
            justify-content: center;
            align-items: center;
        }
        .small-modal-overlay.active {
            display: flex;
        }
        .small-modal {
            background: var(--parchment);
            border: 3px solid var(--accent-gold);
            border-radius: 10px;
            width: 100%;
            max-width: 460px;
            padding: 20px 24px;
        }
        .small-modal h2 {
            font-variant: small-caps;
            color: var(--accent-gold);
            font-size: 1.2rem;
            margin-bottom: 14px;
            border-bottom: 2px solid var(--accent-gold);
            padding-bottom: 8px;
        }
        .small-modal-close {
            width: 100%;
            margin-top: 16px;
            padding: 8px;
            background: var(--card-bg);
            color: var(--ink-light);
            border: 2px solid var(--border-dark);
            border-radius: 6px;
            cursor: pointer;
            font-family: inherit;
            font-size: 0.85rem;
            font-variant: small-caps;
            font-weight: bold;
        }
        .small-modal-close:hover { background: var(--parchment-dark); }

        /* Session Manager Modal */
        .session-modal {
            background: var(--parchment);
            border: 3px solid var(--accent-gold);
            border-radius: 10px;
            width: 100%;
            max-width: 580px;
            max-height: 85vh;
            overflow-y: auto;
            padding: 20px 24px;
        }
        .session-modal h2 {
            font-variant: small-caps;
            color: var(--accent-gold);
            font-size: 1.2rem;
            margin-bottom: 14px;
            border-bottom: 2px solid var(--accent-gold);
            padding-bottom: 8px;
        }
        .session-create-row {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }
        .session-create-row input {
            flex: 1;
            padding: 6px 10px;
            border: 2px solid var(--border-dark);
            border-radius: 4px;
            font-family: inherit;
            font-size: 0.85rem;
            background: var(--card-bg);
        }
        .session-create-row button {
            padding: 6px 14px;
            background: var(--accent-green);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-family: inherit;
            font-size: 0.8rem;
            font-weight: bold;
            font-variant: small-caps;
            white-space: nowrap;
        }
        .session-group {
            border: 2px solid var(--border-dark);
            border-radius: 6px;
            margin-bottom: 10px;
            overflow: hidden;
        }
        .session-group-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: var(--parchment-dark);
            cursor: pointer;
            font-weight: bold;
            font-size: 0.9rem;
            font-variant: small-caps;
            user-select: none;
        }
        .session-group-header:hover { background: #d5c48e; }
        .session-group-actions {
            display: flex;
            gap: 4px;
        }
        .session-group-actions button {
            background: none;
            border: 1px solid var(--ink-light);
            border-radius: 3px;
            padding: 2px 8px;
            cursor: pointer;
            font-size: 0.75rem;
            color: var(--ink-light);
        }
        .session-group-actions button:hover {
            background: var(--accent-red);
            color: white;
            border-color: var(--accent-red);
        }
        .session-group-body {
            padding: 8px 12px;
        }
        .session-save-row {
            display: flex;
            gap: 6px;
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--parchment-dark);
        }
        .session-save-row input {
            flex: 1;
            padding: 4px 8px;
            border: 1px solid var(--border-dark);
            border-radius: 3px;
            font-family: inherit;
            font-size: 0.8rem;
            background: white;
        }
        .session-save-row button {
            padding: 4px 10px;
            background: var(--accent-gold);
            color: #1a0e08;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: bold;
            white-space: nowrap;
        }
        .session-encounter-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 0;
            border-bottom: 1px solid var(--parchment-dark);
            font-size: 0.83rem;
        }
        .session-encounter-item:last-child { border-bottom: none; }
        .session-encounter-info { flex: 1; }
        .session-encounter-info .enc-name {
            font-weight: bold;
            color: var(--ink);
        }
        .session-encounter-info .enc-detail {
            font-size: 0.72rem;
            color: var(--ink-light);
        }
        .session-encounter-actions {
            display: flex;
            gap: 4px;
            flex-shrink: 0;
        }
        .session-encounter-actions button {
            padding: 3px 8px;
            border: 1px solid var(--border-dark);
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.75rem;
            font-family: inherit;
            background: var(--card-bg);
        }
        .session-encounter-actions .load-enc-btn {
            background: var(--accent-green);
            color: white;
            border-color: var(--accent-green);
        }
        .session-encounter-actions .delete-enc-btn:hover {
            background: var(--accent-red);
            color: white;
            border-color: var(--accent-red);
        }
        .session-empty-msg {
            font-style: italic;
            color: var(--ink-light);
            font-size: 0.8rem;
            padding: 4px 0;
        }

        .setting-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 0;
            font-size: 0.88rem;
        }
        .setting-label {
            color: var(--ink);
        }
        .toggle-switch {
            position: relative;
            width: 40px;
            height: 22px;
            flex-shrink: 0;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background: #ccc;
            border-radius: 22px;
            transition: 0.2s;
        }
        .toggle-slider:before {
            content: "";
            position: absolute;
            height: 16px;
            width: 16px;
            left: 3px;
            bottom: 3px;
            background: white;
            border-radius: 50%;
            transition: 0.2s;
        }
        .toggle-switch input:checked + .toggle-slider {
            background: var(--accent-red);
        }
        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(18px);
        }

        .about-content {
            font-size: 0.82rem;
            color: var(--ink-light);
            line-height: 1.6;
        }
        .about-content p {
            margin-bottom: 10px;
        }
        .about-content a {
            color: var(--accent-red);
            text-decoration: none;
        }
        .about-content a:hover {
            text-decoration: underline;
        }

        /* ===== B&W PRINT MODE ===== */
        .bw-print .init-card-header {
            background: white !important;
            color: #000 !important;
            border-bottom: 2px solid #333;
        }
        .bw-print .init-card-header .card-name { color: #000; }
        .bw-print .init-card-header .card-cr {
            background: white !important;
            color: #000 !important;
            border: 2px solid #333;
        }
        .bw-print .card-combat-stat {
            background: white !important;
            border: 1px solid #999;
        }
        .bw-print .card-combat-stat .stat-label { color: #333 !important; }
        .bw-print .card-combat-stat .stat-value { color: #000 !important; }
        .bw-print .card-abilities {
            background: white !important;
            border: 1px solid #999;
        }
        .bw-print .card-abilities .ab-label { color: #333 !important; }
        .bw-print .card-actions-section .card-section-title {
            color: #000 !important;
            border-bottom-color: #333 !important;
        }
        .bw-print .init-card-footer {
            background: white !important;
            border-top-color: #333 !important;
        }
        .bw-print .card-special-line strong { color: #000 !important; }

        /* ===== PRINT STYLES ===== */
        @media print {
            body { background: white; }
            header, .party-panel, .monster-panel, .detail-panel { display: none !important; }
            .app-container { display: none !important; }
            .print-area {
                display: block !important;
                padding: 0;
                background: white !important;
            }
            .print-paper {
                box-shadow: none !important;
                padding: 0 !important;
                margin: 0 !important;
            }
            .print-preview-actions { display: none !important; }
            .print-close-btn { display: none !important; }
            .print-page {
                page-break-after: always;
            }
            .print-page:last-child {
                page-break-after: avoid;
            }
            .init-card {
                border: 2px solid #333 !important;
                break-inside: avoid;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
        }

        /* ===== PRINT AREA (hidden on screen) ===== */
        .print-area {
            display: none;
        }
        .print-area.visible {
            display: block;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: #e0e0e0;
            z-index: 1000;
            overflow-y: auto;
            padding: 40px 20px;
        }
        .print-close-btn {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 1001;
            background: var(--accent-red);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 16px;
            cursor: pointer;
            font-family: inherit;
            font-size: 0.9rem;
            font-weight: bold;
        }
        .print-close-btn:hover { background: #a02020; }

        /* Toast Notification */
        .toast-notification {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.8);
            opacity: 0;
            background: var(--ink);
            color: var(--parchment);
            padding: 20px 32px;
            border-radius: 8px;
            font-family: inherit;
            font-size: 1.1rem;
            font-weight: bold;
            z-index: 2000;
            box-shadow: 0 6px 24px rgba(0,0,0,0.4);
            transition: transform 0.3s ease, opacity 0.3s ease;
            pointer-events: none;
            text-align: center;
            max-width: 400px;
        }
        .toast-notification.visible {
            transform: translate(-50%, -50%) scale(1);
            opacity: 1;
        }

        /* Print Paper Container */
        .print-paper {
            background: white;
            max-width: 900px;
            margin: 0 auto;
            padding: 40px 40px 60px;
            box-shadow: 0 2px 16px rgba(0, 0, 0, 0.25);
            border-radius: 2px;
            min-height: 600px;
        }

        /* Print Preview Action Buttons */
        .print-preview-actions {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin: 10px 0;
        }
        .print-action-btn {
            padding: 10px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            font-family: inherit;
            transition: opacity 0.2s;
        }
        .print-action-btn:hover { opacity: 0.85; }
        .print-btn-print {
            background: var(--accent-red);
            color: white;
        }
        .print-btn-pdf {
            background: var(--accent-gold);
            color: #1a0e08;
        }

        /* Initiative Cards */
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
            gap: 16px;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px 0;
        }
        .init-card {
            border: 3px solid var(--border-dark);
            border-radius: 8px;
            padding: 0;
            background: white;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            page-break-inside: avoid;
            break-inside: avoid;
        }
        .init-card-header {
            background: linear-gradient(135deg, #1a0e08, #3c2415);
            color: var(--parchment);
            padding: 8px 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .init-card-header .card-name {
            font-size: 1rem;
            font-weight: bold;
            font-variant: small-caps;
            letter-spacing: 1px;
        }
        .init-card-header .card-cr {
            background: var(--accent-gold);
            color: #1a0e08;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: bold;
        }
        .init-card-body {
            padding: 8px 12px;
            flex: 1;
            font-size: 0.78rem;
        }
        .init-card-body .card-meta {
            font-style: italic;
            color: var(--ink-light);
            font-size: 0.72rem;
            margin-bottom: 6px;
        }
        .card-combat-stats {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 4px;
            margin-bottom: 6px;
        }
        .card-combat-stat {
            text-align: center;
            padding: 4px;
            background: #f5f0e0;
            border-radius: 4px;
        }
        .card-combat-stat .stat-label {
            font-size: 0.6rem;
            text-transform: uppercase;
            color: var(--ink-light);
            font-weight: bold;
        }
        .card-combat-stat .stat-value {
            font-size: 1rem;
            font-weight: bold;
            color: var(--accent-red);
        }
        .card-abilities {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 2px;
            text-align: center;
            margin-bottom: 6px;
            padding: 4px;
            background: #f5f0e0;
            border-radius: 4px;
        }
        .card-abilities .ab-label {
            font-size: 0.55rem;
            font-weight: bold;
            color: var(--accent-red);
            text-transform: uppercase;
        }
        .card-abilities .ab-val {
            font-size: 0.78rem;
            font-weight: bold;
        }
        .card-actions-section {
            margin-top: 4px;
        }
        .card-actions-section .card-section-title {
            font-size: 0.7rem;
            font-weight: bold;
            font-variant: small-caps;
            color: var(--accent-red);
            border-bottom: 1px solid var(--accent-red);
            margin-bottom: 3px;
            padding-bottom: 1px;
        }
        .card-action-item {
            font-size: 0.68rem;
            margin-bottom: 2px;
            line-height: 1.3;
        }
        .card-action-item .action-name {
            font-weight: bold;
            font-style: italic;
        }
        .init-card-footer {
            background: #f5f0e0;
            padding: 6px 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top: 2px solid var(--border-dark);
        }
        .init-track {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .init-track .init-label {
            font-size: 0.65rem;
            text-transform: uppercase;
            font-weight: bold;
            color: var(--ink-light);
        }
        .init-track .init-box {
            width: 36px;
            height: 28px;
            border: 2px solid var(--border-dark);
            border-radius: 4px;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.85rem;
            color: var(--ink);
        }
        .hp-tracker {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .hp-tracker .hp-label {
            font-size: 0.65rem;
            text-transform: uppercase;
            font-weight: bold;
            color: var(--ink-light);
        }
        .hp-boxes {
            display: flex;
            gap: 2px;
        }
        .hp-box {
            width: 18px;
            height: 18px;
            border: 1.5px solid var(--border-dark);
            border-radius: 3px;
            background: white;
        }
        .card-special-line {
            font-size: 0.65rem;
            color: var(--ink-light);
            margin-bottom: 2px;
        }

        /* Encounter Summary Sheet */
        .summary-sheet {
            page-break-after: always;
            margin-bottom: 30px;
        }
        .summary-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.75rem;
            margin-top: 12px;
        }
        .summary-table th {
            background: var(--ink);
            color: var(--parchment);
            padding: 6px 8px;
            text-align: left;
            font-variant: small-caps;
            font-size: 0.7rem;
            letter-spacing: 0.5px;
        }
        .summary-table td {
            padding: 5px 8px;
            border-bottom: 1px solid #ccc;
            vertical-align: top;
        }
        .summary-table tr:nth-child(even) td {
            background: #f9f5eb;
        }
        .summary-table .num-col {
            text-align: center;
        }
        .summary-attacks {
            font-size: 0.68rem;
            color: var(--ink-light);
        }

        /* Encounter warnings */
        .encounter-warnings {
            margin-top: 8px;
        }
        .warning {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 4px;
            padding: 6px 8px;
            font-size: 0.75rem;
            margin-bottom: 4px;
            color: #856404;
        }
        .warning.danger {
            background: #f8d7da;
            border-color: #dc3545;
            color: #721c24;
        }
        .warning.info {
            background: #d1ecf1;
            border-color: #17a2b8;
            color: #0c5460;
        }

        /* Sort control */
        .sort-control {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.8rem;
        }
        .sort-control label {
            font-variant: small-caps;
            color: var(--ink-light);
            font-weight: bold;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--ink-light);
        }
        .loading-spinner {
            display: inline-block;
            width: 30px;
            height: 30px;
            border: 3px solid var(--parchment-dark);
            border-top-color: var(--accent-red);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Encounter Stat Totals */
        .encounter-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid var(--parchment-dark);
        }
        .enc-stat {
            font-size: 0.75rem;
            color: var(--ink-light);
        }
        .enc-stat strong { color: var(--ink); }

        /* Responsive */
        @media (max-width: 1200px) {
            .app-container {
                grid-template-columns: 280px 1fr 300px;
            }
        }
        @media (max-width: 900px) {
            .app-container {
                grid-template-columns: 1fr;
                height: auto;
            }
            .party-panel, .detail-panel {
                border: none;
                border-bottom: 3px solid var(--border-dark);
            }
        }
    </style>
</head>
<body>

<header>
    <div>
        <h1>2d6 Kobolds</h1>
        <div class="subtitle">5e Encounter Designer & Initiative Card Printer</div>
    </div>
    <a class="header-promo" href="https://dragonizer.net/dragonizer/" target="_blank">Try <strong>Dragonizer</strong>, the homebrew 5e character creator! &#8594;</a>
    <div class="header-buttons">
        <button class="header-btn header-btn-homebrew" onclick="openHomebrewManager()">&#9878; Homebrew</button>
        <button class="header-btn" onclick="showPrintPreview()">&#128424; Print</button>
        <button class="header-btn" onclick="showSummarySheet()">&#128203; Summary</button>
        <button class="header-btn" onclick="openSessionManager()">&#128218; Save Session</button>
        <button class="header-btn" onclick="openSettingsModal()">&#9881; Settings</button>
        <button class="header-btn" onclick="openAboutModal()">&#9432; About</button>
    </div>
</header>

<div class="app-container">
    <!-- LEFT PANEL: Party Configuration & Encounter -->
    <div class="panel party-panel">
        <div class="panel-header">Party Configuration</div>

        <div class="config-row">
            <div class="config-group">
                <label>Number of Players</label>
                <input type="number" id="partySize" value="4" min="1" max="10" onchange="recalcBudget()">
            </div>
            <div class="config-group">
                <label>Party Level</label>
                <input type="number" id="partyLevel" value="3" min="1" max="20" onchange="recalcBudget()">
            </div>
        </div>

        <div class="config-group">
            <label>Encounter Difficulty</label>
            <div class="difficulty-selector">
                <button class="diff-btn" data-diff="low" onclick="setDifficulty('low')">Low</button>
                <button class="diff-btn active-moderate" data-diff="moderate" onclick="setDifficulty('moderate')">Moderate</button>
                <button class="diff-btn" data-diff="high" onclick="setDifficulty('high')">High</button>
            </div>
        </div>

        <div class="budget-display">
            <div class="budget-title">XP Budget</div>
            <div class="budget-numbers">
                <div class="budget-item">
                    <div class="value" id="budgetTotal">900</div>
                    <div class="label">Total Budget</div>
                </div>
                <div class="budget-item">
                    <div class="value" id="budgetRemaining">900</div>
                    <div class="label">Remaining</div>
                </div>
                <div class="budget-item">
                    <div class="value" id="budgetSpent">0</div>
                    <div class="label">Spent</div>
                </div>
                <div class="budget-item">
                    <div class="value" id="monsterCount">0</div>
                    <div class="label">Monsters</div>
                </div>
            </div>
            <div class="budget-bar-container">
                <div class="budget-bar-bg">
                    <div class="budget-bar-fill" id="budgetBar" style="width: 0%; background: var(--low);"></div>
                </div>
                <div class="budget-bar-label" id="budgetBarLabel">0% of budget used</div>
            </div>
        </div>

        <div class="encounter-warnings" id="encounterWarnings"></div>

        <div class="encounter-summary">
            <h3>Current Encounter</h3>
            <ul class="encounter-monster-list" id="encounterList">
                <li style="color: var(--ink-light); font-style: italic; font-size: 0.8rem; justify-content: center;">
                    Click + on a monster to add it
                </li>
            </ul>

            <div class="encounter-stats" id="encounterStats" style="display:none;">
                <div class="enc-stat"><strong>Total XP:</strong> <span id="totalXP">0</span></div>
                <div class="enc-stat"><strong>Per Player:</strong> <span id="xpPerPlayer">0</span></div>
                <div class="enc-stat"><strong>Creatures:</strong> <span id="totalCreatures">0</span></div>
                <div class="enc-stat"><strong>Avg CR:</strong> <span id="avgCR">0</span></div>
            </div>

            <button class="clear-encounter-btn" onclick="clearEncounter()">Clear Encounter</button>
        </div>

    </div>

    <!-- CENTER PANEL: Monster Browser -->
    <div class="panel monster-panel">
        <div class="panel-header-row">
            <div class="panel-header">Monster Compendium</div>
            <button class="stat-block-btn add-new-btn" onclick="openHomebrewEditor()">&#10022; Add New</button>
        </div>

        <div class="search-bar">
            <input type="text" id="searchInput" placeholder="Search monsters by name..." oninput="filterMonsters()">
        </div>

        <div class="filter-row">
            <select id="filterType" onchange="filterMonsters()">
                <option value="">All Types</option>
                <option value="Aberration">Aberration</option>
                <option value="Beast">Beast</option>
                <option value="Celestial">Celestial</option>
                <option value="Construct">Construct</option>
                <option value="Dragon">Dragon</option>
                <option value="Elemental">Elemental</option>
                <option value="Fey">Fey</option>
                <option value="Fiend">Fiend</option>
                <option value="Giant">Giant</option>
                <option value="Humanoid">Humanoid</option>
                <option value="Monstrosity">Monstrosity</option>
                <option value="Ooze">Ooze</option>
                <option value="Plant">Plant</option>
                <option value="Undead">Undead</option>
            </select>
            <select id="filterCR" onchange="filterMonsters()">
                <option value="">All CRs</option>
                <option value="0">CR 0</option>
                <option value="1/8">CR 1/8</option>
                <option value="1/4">CR 1/4</option>
                <option value="1/2">CR 1/2</option>
                <option value="1">CR 1</option>
                <option value="2">CR 2</option>
                <option value="3">CR 3</option>
                <option value="4">CR 4</option>
                <option value="5">CR 5</option>
                <option value="6">CR 6</option>
                <option value="7">CR 7</option>
                <option value="8">CR 8</option>
                <option value="9">CR 9</option>
                <option value="10">CR 10</option>
                <option value="11">CR 11</option>
                <option value="12">CR 12</option>
                <option value="13">CR 13</option>
                <option value="14">CR 14</option>
                <option value="15">CR 15</option>
                <option value="16">CR 16</option>
                <option value="17">CR 17</option>
                <option value="18">CR 18</option>
                <option value="19">CR 19</option>
                <option value="20">CR 20</option>
                <option value="21">CR 21</option>
                <option value="22">CR 22</option>
                <option value="23">CR 23</option>
                <option value="24">CR 24</option>
                <option value="30">CR 30</option>
            </select>
            <select id="filterSize" onchange="filterMonsters()">
                <option value="">All Sizes</option>
                <option value="Tiny">Tiny</option>
                <option value="Small">Small</option>
                <option value="Medium">Medium</option>
                <option value="Large">Large</option>
                <option value="Huge">Huge</option>
                <option value="Gargantuan">Gargantuan</option>
            </select>
            <select id="filterSource" onchange="filterMonsters()">
                <option value="">All Sources</option>
                <option value="srd">SRD Only</option>
                <option value="homebrew">Homebrew Only</option>
            </select>
            <div class="sort-control">
                <label>Sort:</label>
                <select id="sortBy" onchange="filterMonsters()">
                    <option value="name">Name</option>
                    <option value="cr">CR (Low-High)</option>
                    <option value="cr-desc">CR (High-Low)</option>
                    <option value="type">Type</option>
                    <option value="hp">HP</option>
                </select>
            </div>
            <span class="monster-count-label" id="filteredCount"></span>
        </div>

        <div class="monster-grid" id="monsterGrid">
            <div class="loading">
                <div class="loading-spinner"></div>
                <p>Loading monsters...</p>
            </div>
        </div>
    </div>

    <!-- RIGHT PANEL: Monster Detail / Stat Block -->
    <div class="panel detail-panel">
        <div class="panel-header-row">
            <div class="panel-header">Stat Block</div>
            <button class="stat-block-btn clone-btn" id="cloneBtn" onclick="cloneMonster()">Clone</button>
        </div>
        <div id="statBlockArea">
            <div class="detail-placeholder">
                Click on a monster to view its full stat block here
            </div>
        </div>
    </div>
</div>

<!-- SETTINGS MODAL -->
<div class="small-modal-overlay" id="settingsModalOverlay" onclick="if(event.target===this)closeSettingsModal()">
    <div class="small-modal">
        <h2>&#9881; Settings</h2>
        <div class="setting-row">
            <span class="setting-label">B&W Print Mode</span>
            <label class="toggle-switch">
                <input type="checkbox" id="bwPrintToggle" onchange="toggleBWPrint(this.checked)">
                <span class="toggle-slider"></span>
            </label>
        </div>
        <div class="setting-row">
            <span class="setting-label">Preroll Initiative</span>
            <label class="toggle-switch">
                <input type="checkbox" id="prerollInitToggle" onchange="togglePrerollInit(this.checked)">
                <span class="toggle-slider"></span>
            </label>
        </div>
        <div class="setting-row">
            <span class="setting-label">Print Summary Sheet with Cards</span>
            <label class="toggle-switch">
                <input type="checkbox" id="printSummaryToggle" onchange="togglePrintSummary(this.checked)">
                <span class="toggle-slider"></span>
            </label>
        </div>
        <div class="setting-row">
            <span class="setting-label">Clear Encounter on Save</span>
            <label class="toggle-switch">
                <input type="checkbox" id="clearOnSaveToggle" onchange="toggleClearOnSave(this.checked)">
                <span class="toggle-slider"></span>
            </label>
        </div>
        <button class="small-modal-close" onclick="closeSettingsModal()">Close</button>
    </div>
</div>

<!-- ABOUT MODAL -->
<div class="small-modal-overlay" id="aboutModalOverlay" onclick="if(event.target===this)closeAboutModal()">
    <div class="small-modal">
        <h2>&#9432; About</h2>
        <div class="about-content">
            <p>This work includes material from the System Reference Document 5.2 ("SRD 5.2") by Wizards of the Coast LLC, available at <a href="https://www.dndbeyond.com/srd" target="_blank" rel="noopener">https://www.dndbeyond.com/srd</a>. The SRD 5.2 is licensed under the Creative Commons Attribution 4.0 International License, available at <a href="https://creativecommons.org/licenses/by/4.0/legalcode" target="_blank" rel="noopener">https://creativecommons.org/licenses/by/4.0/legalcode</a>.</p>
            <p>Made by <a href="https://sevrlbats.bsky.social/" target="_blank" rel="noopener">sevrL_bats</a> on Bluesky.</p>
        </div>
        <button class="small-modal-close" onclick="closeAboutModal()">Close</button>
    </div>
</div>

<!-- SESSION MANAGER MODAL -->
<div class="small-modal-overlay" id="sessionModalOverlay" onclick="if(event.target===this)closeSessionManager()">
    <div class="session-modal">
        <h2>&#128218; Session Manager</h2>
        <div id="sessionManagerContent"></div>
        <button class="small-modal-close" onclick="closeSessionManager()">Close</button>
    </div>
</div>

<!-- HOMEBREW MANAGER MODAL -->
<div class="small-modal-overlay" id="homebrewModalOverlay" onclick="if(event.target===this)closeHomebrewManager()">
    <div class="small-modal">
        <h2>&#9878; Homebrew Manager</h2>
        <div class="homebrew-count-label" id="homebrewCountLabel">0 homebrew monsters</div>
        <button class="hb-btn hb-btn-primary" onclick="closeHomebrewManager();openHomebrewEditor()">Create New Monster</button>
        <button class="hb-btn" onclick="exportHomebrew()">Export Homebrew (JSON)</button>
        <button class="hb-btn" onclick="document.getElementById('importFileInput').click()">Import Homebrew (JSON)</button>
        <input type="file" id="importFileInput" multiple accept=".json" style="display:none;" onchange="importHomebrew(this.files)">
        <div id="homebrewManagerList" style="margin-top: 12px;"></div>
        <button class="small-modal-close" onclick="closeHomebrewManager()">Close</button>
    </div>
</div>

<!-- PRINT AREA -->
<div class="print-area" id="printArea">
    <button class="print-close-btn" onclick="closePrintPreview()">Close Preview</button>
    <div id="printContent"></div>
</div>

<!-- HOMEBREW EDITOR MODAL -->
<div class="hb-modal-overlay" id="hbModalOverlay" onclick="if(event.target===this)closeHomebrewEditor()">
    <div class="hb-modal">
        <h2 id="hbModalTitle">Create New Monster</h2>
        <div class="hb-form-section">
            <h3>Basic Info</h3>
            <div class="hb-form-grid">
                <div class="hb-form-field full-width"><label>Name *</label><input type="text" id="hbName"></div>
                <div class="hb-form-field"><label>Size</label>
                    <select id="hbSize"><option>Tiny</option><option>Small</option><option selected>Medium</option><option>Large</option><option>Huge</option><option>Gargantuan</option></select>
                </div>
                <div class="hb-form-field"><label>Type</label>
                    <select id="hbType"><option>Aberration</option><option>Beast</option><option>Celestial</option><option>Construct</option><option>Dragon</option><option>Elemental</option><option>Fey</option><option>Fiend</option><option>Giant</option><option selected>Humanoid</option><option>Monstrosity</option><option>Ooze</option><option>Plant</option><option>Undead</option></select>
                </div>
                <div class="hb-form-field full-width"><label>Alignment</label><input type="text" id="hbAlignment" placeholder="e.g. Chaotic Evil"></div>
            </div>
        </div>
        <div class="hb-form-section">
            <h3>Combat Stats</h3>
            <div class="hb-form-grid three-col">
                <div class="hb-form-field"><label>AC *</label><input type="text" id="hbAC" placeholder="e.g. 15 (natural armor)"></div>
                <div class="hb-form-field"><label>HP *</label><input type="number" id="hbHP" min="1"></div>
                <div class="hb-form-field"><label>HP Dice</label><input type="text" id="hbHPDice" placeholder="e.g. 8d10+40"></div>
                <div class="hb-form-field"><label>Speed</label><input type="text" id="hbSpeed" placeholder="e.g. 30 ft., fly 60 ft."></div>
                <div class="hb-form-field"><label>Initiative</label><input type="number" id="hbInitiative"></div>
                <div class="hb-form-field"><label>CR *</label>
                    <select id="hbCR" onchange="autoFillXP()">
                        <option value="0">0</option><option value="1/8">1/8</option><option value="1/4">1/4</option><option value="1/2">1/2</option>
                        <option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option>
                        <option value="6">6</option><option value="7">7</option><option value="8">8</option><option value="9">9</option><option value="10">10</option>
                        <option value="11">11</option><option value="12">12</option><option value="13">13</option><option value="14">14</option><option value="15">15</option>
                        <option value="16">16</option><option value="17">17</option><option value="18">18</option><option value="19">19</option><option value="20">20</option>
                        <option value="21">21</option><option value="22">22</option><option value="23">23</option><option value="24">24</option><option value="25">25</option>
                        <option value="26">26</option><option value="27">27</option><option value="28">28</option><option value="29">29</option><option value="30">30</option>
                    </select>
                </div>
                <div class="hb-form-field"><label>XP</label><input type="number" id="hbXP" min="0"></div>
            </div>
        </div>
        <div class="hb-form-section">
            <h3>Ability Scores</h3>
            <div class="hb-form-grid six-col">
                <div class="hb-form-field"><label>STR</label><input type="number" id="hbSTR" value="10" min="1" max="30"></div>
                <div class="hb-form-field"><label>DEX</label><input type="number" id="hbDEX" value="10" min="1" max="30"></div>
                <div class="hb-form-field"><label>CON</label><input type="number" id="hbCON" value="10" min="1" max="30"></div>
                <div class="hb-form-field"><label>INT</label><input type="number" id="hbINT" value="10" min="1" max="30"></div>
                <div class="hb-form-field"><label>WIS</label><input type="number" id="hbWIS" value="10" min="1" max="30"></div>
                <div class="hb-form-field"><label>CHA</label><input type="number" id="hbCHA" value="10" min="1" max="30"></div>
            </div>
        </div>
        <div class="hb-form-section">
            <h3>Details</h3>
            <div class="hb-form-grid">
                <div class="hb-form-field full-width"><label>Skills</label><input type="text" id="hbSkills" placeholder="e.g. Perception +5, Stealth +7"></div>
                <div class="hb-form-field full-width"><label>Senses</label><input type="text" id="hbSenses" placeholder="e.g. Darkvision 60 ft., Passive Perception 15"></div>
                <div class="hb-form-field full-width"><label>Languages</label><input type="text" id="hbLanguages" placeholder="e.g. Common, Draconic"></div>
                <div class="hb-form-field full-width"><label>Resistances</label><input type="text" id="hbResistances" placeholder="e.g. Fire, Cold"></div>
                <div class="hb-form-field full-width"><label>Immunities</label><input type="text" id="hbImmunities" placeholder="e.g. Poison; Poisoned"></div>
                <div class="hb-form-field full-width"><label>Vulnerabilities</label><input type="text" id="hbVulnerabilities" placeholder="e.g. Radiant"></div>
            </div>
        </div>
        <div class="hb-form-section">
            <h3>Traits</h3>
            <div class="hb-dynamic-list" id="hbTraitsList"></div>
            <button class="hb-add-entry-btn" onclick="addDynamicEntry('hbTraitsList')">+ Add Trait</button>
        </div>
        <div class="hb-form-section">
            <h3>Actions</h3>
            <div class="hb-dynamic-list" id="hbActionsList"></div>
            <button class="hb-add-entry-btn" onclick="addDynamicEntry('hbActionsList')">+ Add Action</button>
        </div>
        <div class="hb-form-section">
            <h3>Bonus Actions</h3>
            <div class="hb-dynamic-list" id="hbBonusActionsList"></div>
            <button class="hb-add-entry-btn" onclick="addDynamicEntry('hbBonusActionsList')">+ Add Bonus Action</button>
        </div>
        <div class="hb-form-section">
            <h3>Reactions</h3>
            <div class="hb-dynamic-list" id="hbReactionsList"></div>
            <button class="hb-add-entry-btn" onclick="addDynamicEntry('hbReactionsList')">+ Add Reaction</button>
        </div>
        <div class="hb-form-section">
            <h3>Legendary Actions</h3>
            <div class="hb-dynamic-list" id="hbLegendaryActionsList"></div>
            <button class="hb-add-entry-btn" onclick="addDynamicEntry('hbLegendaryActionsList')">+ Add Legendary Action</button>
        </div>
        <div class="hb-modal-actions">
            <button class="hb-cancel-btn" onclick="closeHomebrewEditor()">Cancel</button>
            <button class="hb-save-btn" onclick="saveHomebrewMonster()">Save Monster</button>
        </div>
    </div>
</div>

<script>
// ===== ENCOUNTER BALANCE DATA (SRD 5.2) =====
const XP_BUDGET_TABLE = {
    1:  { low: 50, moderate: 75, high: 100 },
    2:  { low: 100, moderate: 150, high: 200 },
    3:  { low: 150, moderate: 225, high: 400 },
    4:  { low: 250, moderate: 375, high: 500 },
    5:  { low: 500, moderate: 750, high: 1100 },
    6:  { low: 600, moderate: 1000, high: 1400 },
    7:  { low: 750, moderate: 1300, high: 1700 },
    8:  { low: 1000, moderate: 1700, high: 2100 },
    9:  { low: 1300, moderate: 2000, high: 2600 },
    10: { low: 1600, moderate: 2300, high: 3100 },
    11: { low: 1900, moderate: 2900, high: 4100 },
    12: { low: 2200, moderate: 3700, high: 4700 },
    13: { low: 2600, moderate: 4200, high: 5400 },
    14: { low: 2900, moderate: 4900, high: 6200 },
    15: { low: 3300, moderate: 5400, high: 7800 },
    16: { low: 3800, moderate: 6100, high: 9800 },
    17: { low: 4500, moderate: 7200, high: 11700 },
    18: { low: 5000, moderate: 8700, high: 14200 },
    19: { low: 5500, moderate: 10700, high: 17200 },
    20: { low: 6400, moderate: 13200, high: 22000 },
};

const CR_XP_MAP = {
    "0": 0, "1/8": 25, "1/4": 50, "1/2": 100,
    "1": 200, "2": 450, "3": 700, "4": 1100, "5": 1800,
    "6": 2300, "7": 2900, "8": 3900, "9": 5000, "10": 5900,
    "11": 7200, "12": 8400, "13": 10000, "14": 11500, "15": 13000,
    "16": 15000, "17": 18000, "18": 20000, "19": 22000, "20": 25000,
    "21": 33000, "22": 41000, "23": 50000, "24": 62000, "25": 75000,
    "26": 90000, "27": 105000, "28": 120000, "29": 135000, "30": 155000
};

function crToNum(cr) {
    if (cr === "1/8") return 0.125;
    if (cr === "1/4") return 0.25;
    if (cr === "1/2") return 0.5;
    return parseFloat(cr);
}

// ===== STATE =====
let allMonsters = [];
let filteredMonsters = [];
let encounter = []; // { monster, count }
let selectedMonster = null;
let currentDifficulty = 'moderate';

// ===== SETTINGS =====
const SETTINGS_STORAGE_KEY = '2d6kobolds_settings';
let appSettings = { bwPrint: true, prerollInitiative: false, printSummarySheet: true, clearOnSave: true };

function loadSettings() {
    try {
        const saved = localStorage.getItem(SETTINGS_STORAGE_KEY);
        if (saved) appSettings = Object.assign(appSettings, JSON.parse(saved));
    } catch (e) {}
    applySettings();
}

function saveSettings() {
    localStorage.setItem(SETTINGS_STORAGE_KEY, JSON.stringify(appSettings));
}

function applySettings() {
    // B&W Print Mode
    document.body.classList.toggle('bw-print', appSettings.bwPrint);
    const toggle = document.getElementById('bwPrintToggle');
    if (toggle) toggle.checked = appSettings.bwPrint;
    // Preroll Initiative
    const prerollToggle = document.getElementById('prerollInitToggle');
    if (prerollToggle) prerollToggle.checked = !!appSettings.prerollInitiative;
    // Print Summary Sheet
    const summaryToggle = document.getElementById('printSummaryToggle');
    if (summaryToggle) summaryToggle.checked = appSettings.printSummarySheet !== false;
    // Clear Encounter on Save
    const clearOnSaveToggle = document.getElementById('clearOnSaveToggle');
    if (clearOnSaveToggle) clearOnSaveToggle.checked = appSettings.clearOnSave !== false;
}

function toggleBWPrint(enabled) {
    appSettings.bwPrint = enabled;
    document.body.classList.toggle('bw-print', enabled);
    saveSettings();
}

function togglePrerollInit(enabled) {
    appSettings.prerollInitiative = enabled;
    saveSettings();
}

function togglePrintSummary(enabled) {
    appSettings.printSummarySheet = enabled;
    saveSettings();
}

function toggleClearOnSave(enabled) {
    appSettings.clearOnSave = enabled;
    saveSettings();
}

function openSettingsModal() {
    document.getElementById('settingsModalOverlay').classList.add('active');
}

function closeSettingsModal() {
    document.getElementById('settingsModalOverlay').classList.remove('active');
}

function openAboutModal() {
    document.getElementById('aboutModalOverlay').classList.add('active');
}

function closeAboutModal() {
    document.getElementById('aboutModalOverlay').classList.remove('active');
}

// ===== HOMEBREW SYSTEM =====
const HOMEBREW_STORAGE_KEY = '2d6kobolds_homebrew_monsters';
let homebrewMonsters = [];
let editingHomebrewIndex = -1; // -1 = creating new, >=0 = editing existing
let replacingEncounterIndex = -1; // -1 = not replacing, >=0 = replace encounter entry at this index on save

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function loadHomebrewFromStorage() {
    try {
        const saved = localStorage.getItem(HOMEBREW_STORAGE_KEY);
        if (saved) {
            homebrewMonsters = JSON.parse(saved);
            homebrewMonsters.forEach(m => m.isHomebrew = true);
        }
    } catch (e) {
        console.warn('Failed to load homebrew monsters:', e);
    }
}

function saveHomebrewToStorage() {
    const toSave = homebrewMonsters.map(m => {
        const copy = {...m};
        delete copy.isHomebrew;
        return copy;
    });
    localStorage.setItem(HOMEBREW_STORAGE_KEY, JSON.stringify(toSave));
    updateHomebrewCount();
}

function mergeHomebrewIntoAllMonsters() {
    // Remove old homebrew from allMonsters
    allMonsters = allMonsters.filter(m => !m.isHomebrew);
    // Add current homebrew (tagged)
    for (const m of homebrewMonsters) {
        m.isHomebrew = true;
        allMonsters.push(m);
    }
    filterMonsters();
}

function updateHomebrewCount() {
    const label = document.getElementById('homebrewCountLabel');
    if (label) {
        label.textContent = `${homebrewMonsters.length} homebrew monster${homebrewMonsters.length !== 1 ? 's' : ''}`;
    }
}

// --- Dynamic Entry Helpers ---
function addDynamicEntry(listId, name, desc) {
    const list = document.getElementById(listId);
    const entry = document.createElement('div');
    entry.className = 'hb-dynamic-entry';
    entry.innerHTML = `
        <input type="text" placeholder="Name" value="${escapeHtml(name || '')}">
        <textarea placeholder="Description">${escapeHtml(desc || '')}</textarea>
        <button class="hb-remove-entry" onclick="this.parentElement.remove()" title="Remove">&times;</button>
    `;
    list.appendChild(entry);
}

function getDynamicEntries(listId) {
    const list = document.getElementById(listId);
    const entries = [];
    for (const entry of list.querySelectorAll('.hb-dynamic-entry')) {
        const name = entry.querySelector('input').value.trim();
        const desc = entry.querySelector('textarea').value.trim();
        if (name || desc) entries.push({ name: name || 'Unnamed', description: desc });
    }
    return entries;
}

// --- Editor Modal ---
function openHomebrewEditor(prefillMonster, editIndex) {
    editingHomebrewIndex = (editIndex !== undefined) ? editIndex : -1;
    const overlay = document.getElementById('hbModalOverlay');
    const title = document.getElementById('hbModalTitle');
    title.textContent = editingHomebrewIndex >= 0 ? 'Edit Homebrew Monster' : (prefillMonster ? 'Save As Homebrew' : 'Create New Monster');

    // Clear dynamic lists
    for (const id of ['hbTraitsList', 'hbActionsList', 'hbBonusActionsList', 'hbReactionsList', 'hbLegendaryActionsList']) {
        document.getElementById(id).innerHTML = '';
    }

    if (prefillMonster) {
        const m = prefillMonster;
        document.getElementById('hbName').value = m.name || '';
        document.getElementById('hbSize').value = m.size || 'Medium';
        document.getElementById('hbType').value = m.type || 'Humanoid';
        document.getElementById('hbAlignment').value = m.alignment || '';
        document.getElementById('hbAC').value = m.ac || '';
        document.getElementById('hbHP').value = m.hp || '';
        document.getElementById('hbHPDice').value = m.hpDice || '';
        document.getElementById('hbSpeed').value = m.speed || '30 ft.';
        document.getElementById('hbInitiative').value = m.initiative != null ? m.initiative : '';
        document.getElementById('hbCR').value = m.cr || '0';
        document.getElementById('hbXP').value = m.xp || 0;
        document.getElementById('hbSTR').value = m.str || 10;
        document.getElementById('hbDEX').value = m.dex || 10;
        document.getElementById('hbCON').value = m.con || 10;
        document.getElementById('hbINT').value = m.int || 10;
        document.getElementById('hbWIS').value = m.wis || 10;
        document.getElementById('hbCHA').value = m.cha || 10;
        document.getElementById('hbSkills').value = m.skills || '';
        document.getElementById('hbSenses').value = m.senses || '';
        document.getElementById('hbLanguages').value = m.languages || '';
        document.getElementById('hbResistances').value = m.resistances || '';
        document.getElementById('hbImmunities').value = m.immunities || '';
        document.getElementById('hbVulnerabilities').value = m.vulnerabilities || '';

        // Populate dynamic arrays
        if (m.traits) m.traits.forEach(t => addDynamicEntry('hbTraitsList', t.name, t.description));
        if (m.actions) m.actions.forEach(a => addDynamicEntry('hbActionsList', a.name, a.description));
        if (m.bonusActions) m.bonusActions.forEach(a => addDynamicEntry('hbBonusActionsList', a.name, a.description));
        if (m.reactions) m.reactions.forEach(a => addDynamicEntry('hbReactionsList', a.name, a.description));
        if (m.legendaryActions) m.legendaryActions.forEach(a => addDynamicEntry('hbLegendaryActionsList', a.name, a.description));
    } else {
        // Clear all fields
        document.getElementById('hbName').value = '';
        document.getElementById('hbSize').value = 'Medium';
        document.getElementById('hbType').value = 'Humanoid';
        document.getElementById('hbAlignment').value = '';
        document.getElementById('hbAC').value = '';
        document.getElementById('hbHP').value = '';
        document.getElementById('hbHPDice').value = '';
        document.getElementById('hbSpeed').value = '30 ft.';
        document.getElementById('hbInitiative').value = '';
        document.getElementById('hbCR').value = '1';
        document.getElementById('hbXP').value = '200';
        document.getElementById('hbSTR').value = 10;
        document.getElementById('hbDEX').value = 10;
        document.getElementById('hbCON').value = 10;
        document.getElementById('hbINT').value = 10;
        document.getElementById('hbWIS').value = 10;
        document.getElementById('hbCHA').value = 10;
        document.getElementById('hbSkills').value = '';
        document.getElementById('hbSenses').value = '';
        document.getElementById('hbLanguages').value = '';
        document.getElementById('hbResistances').value = '';
        document.getElementById('hbImmunities').value = '';
        document.getElementById('hbVulnerabilities').value = '';
    }

    overlay.classList.add('active');
}

function closeHomebrewEditor() {
    document.getElementById('hbModalOverlay').classList.remove('active');
    editingHomebrewIndex = -1;
    replacingEncounterIndex = -1;
}

function autoFillXP() {
    const cr = document.getElementById('hbCR').value;
    const xp = CR_XP_MAP[cr];
    if (xp !== undefined) document.getElementById('hbXP').value = xp;
}

function saveHomebrewMonster() {
    const name = document.getElementById('hbName').value.trim();
    const ac = document.getElementById('hbAC').value.trim();
    const hp = parseInt(document.getElementById('hbHP').value);
    const cr = document.getElementById('hbCR').value;

    // Validate required fields
    if (!name) { alert('Monster name is required.'); return; }
    if (!ac) { alert('AC is required.'); return; }
    if (!hp || hp < 1) { alert('HP must be at least 1.'); return; }

    const monster = {
        name: name,
        size: document.getElementById('hbSize').value,
        type: document.getElementById('hbType').value,
        alignment: document.getElementById('hbAlignment').value.trim(),
        ac: ac,
        hp: hp,
        hpDice: document.getElementById('hbHPDice').value.trim(),
        speed: document.getElementById('hbSpeed').value.trim() || '30 ft.',
        initiative: document.getElementById('hbInitiative').value ? parseInt(document.getElementById('hbInitiative').value) : null,
        cr: cr,
        xp: parseInt(document.getElementById('hbXP').value) || CR_XP_MAP[cr] || 0,
        str: parseInt(document.getElementById('hbSTR').value) || 10,
        dex: parseInt(document.getElementById('hbDEX').value) || 10,
        con: parseInt(document.getElementById('hbCON').value) || 10,
        int: parseInt(document.getElementById('hbINT').value) || 10,
        wis: parseInt(document.getElementById('hbWIS').value) || 10,
        cha: parseInt(document.getElementById('hbCHA').value) || 10,
        skills: document.getElementById('hbSkills').value.trim(),
        senses: document.getElementById('hbSenses').value.trim(),
        languages: document.getElementById('hbLanguages').value.trim(),
        resistances: document.getElementById('hbResistances').value.trim(),
        immunities: document.getElementById('hbImmunities').value.trim(),
        vulnerabilities: document.getElementById('hbVulnerabilities').value.trim(),
        traits: getDynamicEntries('hbTraitsList'),
        actions: getDynamicEntries('hbActionsList'),
        bonusActions: getDynamicEntries('hbBonusActionsList'),
        reactions: getDynamicEntries('hbReactionsList'),
        legendaryActions: getDynamicEntries('hbLegendaryActionsList'),
        isHomebrew: true
    };

    if (editingHomebrewIndex >= 0) {
        // Editing existing - check name not taken by another monster
        const dupeName = allMonsters.find(m => m.name === monster.name && m !== homebrewMonsters[editingHomebrewIndex]);
        if (dupeName) {
            alert(`A monster named "${monster.name}" already exists. Please choose a different name.`);
            return;
        }
        homebrewMonsters[editingHomebrewIndex] = monster;
    } else {
        // Creating new - block duplicate names
        const dupeName = allMonsters.find(m => m.name === monster.name);
        if (dupeName) {
            alert(`A monster named "${monster.name}" already exists. Please choose a different name.`);
            return;
        }
        homebrewMonsters.push(monster);
    }

    saveHomebrewToStorage();
    mergeHomebrewIntoAllMonsters();

    // Capture before closeHomebrewEditor resets it
    const replaceIndex = replacingEncounterIndex;
    closeHomebrewEditor();

    // If we were editing an encounter monster, replace it in the encounter
    if (replaceIndex >= 0 && replaceIndex < encounter.length) {
        const count = encounter[replaceIndex].count;
        // Find the newly saved monster in allMonsters (it's been merged)
        const newMonster = allMonsters.find(m => m.name === monster.name && m.isHomebrew);
        if (newMonster) {
            encounter[replaceIndex] = { monster: newMonster, count };
            renderEncounterList();
            recalcBudget();
            saveEncounterToStorage();
        }
    }

    // Show the saved monster in the stat block
    selectedMonster = monster;
    renderStatBlock(monster);
}

function deleteHomebrewMonster(index) {
    const name = homebrewMonsters[index].name;
    if (!confirm(`Delete homebrew monster "${name}"? This cannot be undone.`)) return;

    // Remove from encounter if present
    encounter = encounter.filter(e => e.monster !== homebrewMonsters[index]);
    saveEncounterToStorage();

    homebrewMonsters.splice(index, 1);
    saveHomebrewToStorage();
    mergeHomebrewIntoAllMonsters();
    renderEncounterList();
    recalcBudget();

    // Clear stat block
    document.getElementById('statBlockArea').innerHTML = '<div class="detail-placeholder">Monster deleted. Click on another monster to view its stat block.</div>';
}

// --- Export/Import ---
function exportHomebrew() {
    if (homebrewMonsters.length === 0) {
        alert('No homebrew monsters to export.');
        return;
    }
    const exportData = {
        version: 1,
        source: '2d6 Kobolds Homebrew',
        exportDate: new Date().toISOString(),
        monsters: homebrewMonsters.map(m => {
            const copy = {...m};
            delete copy.isHomebrew;
            return copy;
        })
    };
    const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `2d6kobolds-homebrew-${new Date().toISOString().slice(0,10)}.json`;
    a.click();
    URL.revokeObjectURL(url);
}

function importHomebrew(files) {
    if (!files || files.length === 0) return;
    let totalImported = 0;
    let totalSkipped = 0;
    let filesProcessed = 0;

    for (const file of files) {
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = JSON.parse(e.target.result);
                let monsters = [];

                // Accept both wrapped format and raw array
                if (Array.isArray(data)) {
                    monsters = data;
                } else if (data.monsters && Array.isArray(data.monsters)) {
                    monsters = data.monsters;
                } else {
                    alert(`File "${file.name}" does not contain valid monster data.`);
                    filesProcessed++;
                    return;
                }

                for (const m of monsters) {
                    // Validate required fields
                    if (!m.name || !m.ac || !m.hp || !m.cr) {
                        totalSkipped++;
                        continue;
                    }

                    // Block duplicate names
                    if (allMonsters.some(ex => ex.name === m.name) || homebrewMonsters.some(hb => hb.name === m.name)) {
                        totalSkipped++;
                        continue;
                    }
                    m.isHomebrew = true;
                    homebrewMonsters.push(m);
                    totalImported++;
                }
            } catch (err) {
                alert(`Error reading file "${file.name}": ${err.message}`);
            }

            filesProcessed++;
            if (filesProcessed === files.length) {
                // All files processed
                saveHomebrewToStorage();
                mergeHomebrewIntoAllMonsters();
                let msg = `Imported ${totalImported} monster${totalImported !== 1 ? 's' : ''}.`;
                if (totalSkipped > 0) msg += ` Skipped ${totalSkipped} invalid entries.`;
                alert(msg);
            }
        };
        reader.readAsText(file);
    }
    // Reset the file input so the same file can be imported again
    document.getElementById('importFileInput').value = '';
}

// ===== INITIALIZATION =====
document.addEventListener('DOMContentLoaded', () => {
    loadSettings();
    loadMonsters();
    recalcBudget();
});

function loadMonsters() {
    // Monster data will be embedded directly
    if (typeof MONSTER_DATA !== 'undefined') {
        allMonsters = MONSTER_DATA.slice(); // copy so SRD originals are untouched
        loadHomebrewFromStorage();
        mergeHomebrewIntoAllMonsters();
        updateHomebrewCount();
        loadEncounterFromStorage();
    } else {
        // Try loading from external file
        fetch('monsters.json')
            .then(r => r.json())
            .then(data => {
                allMonsters = data;
                loadHomebrewFromStorage();
                mergeHomebrewIntoAllMonsters();
                updateHomebrewCount();
                loadEncounterFromStorage();
            })
            .catch(err => {
                document.getElementById('monsterGrid').innerHTML =
                    '<div class="loading"><p>Error loading monsters. Make sure monsters.json is in the same folder.</p></div>';
            });
    }
}

// ===== DIFFICULTY & BUDGET =====
function setDifficulty(diff) {
    currentDifficulty = diff;
    document.querySelectorAll('.diff-btn').forEach(btn => {
        btn.className = 'diff-btn';
        if (btn.dataset.diff === diff) {
            btn.classList.add('active-' + diff);
        }
    });
    recalcBudget();
}

function recalcBudget() {
    const level = Math.max(1, Math.min(20, parseInt(document.getElementById('partyLevel').value) || 1));
    const size = Math.max(1, parseInt(document.getElementById('partySize').value) || 1);
    const budgetPerChar = XP_BUDGET_TABLE[level][currentDifficulty];
    const totalBudget = budgetPerChar * size;

    const spent = getEncounterXP();
    const remaining = totalBudget - spent;
    const pct = totalBudget > 0 ? Math.min(100, (spent / totalBudget) * 100) : 0;

    document.getElementById('budgetTotal').textContent = totalBudget.toLocaleString();
    document.getElementById('budgetRemaining').textContent = remaining.toLocaleString();
    document.getElementById('budgetSpent').textContent = spent.toLocaleString();
    document.getElementById('monsterCount').textContent = getEncounterCreatureCount();

    const bar = document.getElementById('budgetBar');
    bar.style.width = pct + '%';
    if (pct <= 80) bar.style.background = 'var(--low)';
    else if (pct <= 100) bar.style.background = 'var(--moderate)';
    else bar.style.background = 'var(--high)';

    document.getElementById('budgetBarLabel').textContent =
        Math.round(pct) + '% of budget used' + (remaining < 0 ? ' (OVER BUDGET!)' : '');

    updateWarnings(totalBudget, spent, level);
    updateEncounterStats();
}

function getEncounterXP() {
    let total = 0;
    for (const entry of encounter) {
        const xp = entry.monster.xp || CR_XP_MAP[entry.monster.cr] || 0;
        total += xp * entry.count;
    }
    return total;
}

function getEncounterCreatureCount() {
    let total = 0;
    for (const entry of encounter) total += entry.count;
    return total;
}

function updateWarnings(budget, spent, partyLevel) {
    const warnings = [];
    const partySize = parseInt(document.getElementById('partySize').value) || 4;
    const creatureCount = getEncounterCreatureCount();

    if (spent > budget) {
        warnings.push({ type: 'danger', text: `Encounter is ${(spent - budget).toLocaleString()} XP over budget! Consider removing monsters.` });
    }

    // Check for creatures per character ratio
    if (creatureCount > partySize * 2) {
        warnings.push({ type: 'warning', text: `${creatureCount} creatures vs ${partySize} players (>${2}:1 ratio). Include some fragile creatures that can be defeated quickly. Extra important for level 1-2 parties.` });
    }

    // Check for high-CR monsters
    for (const entry of encounter) {
        const monsterCR = crToNum(entry.monster.cr);
        if (monsterCR > partyLevel) {
            warnings.push({ type: 'warning', text: `${entry.monster.name} (CR ${entry.monster.cr}) has CR higher than party level ${partyLevel}. It may one-shot weaker characters.` });
            break;
        }
    }

    // Check stat block count
    const uniqueTypes = new Set(encounter.map(e => e.monster.name)).size;
    if (uniqueTypes > 3) {
        warnings.push({ type: 'info', text: `${uniqueTypes} different stat blocks. The SRD recommends 2-3 per encounter for manageable play.` });
    }

    const container = document.getElementById('encounterWarnings');
    container.innerHTML = warnings.map(w =>
        `<div class="warning ${w.type}">${w.text}</div>`
    ).join('');
}

function updateEncounterStats() {
    const statsDiv = document.getElementById('encounterStats');
    if (encounter.length === 0) {
        statsDiv.style.display = 'none';
        return;
    }
    statsDiv.style.display = 'grid';
    const totalXP = getEncounterXP();
    const partySize = parseInt(document.getElementById('partySize').value) || 4;
    const creatureCount = getEncounterCreatureCount();

    let totalCR = 0;
    for (const entry of encounter) totalCR += crToNum(entry.monster.cr) * entry.count;

    document.getElementById('totalXP').textContent = totalXP.toLocaleString();
    document.getElementById('xpPerPlayer').textContent = Math.floor(totalXP / partySize).toLocaleString();
    document.getElementById('totalCreatures').textContent = creatureCount;
    document.getElementById('avgCR').textContent = creatureCount > 0 ? (totalCR / creatureCount).toFixed(1) : '0';
}

// ===== MONSTER FILTERING & DISPLAY =====
function filterMonsters() {
    const search = document.getElementById('searchInput').value.toLowerCase();
    const type = document.getElementById('filterType').value;
    const cr = document.getElementById('filterCR').value;
    const size = document.getElementById('filterSize').value;
    const source = document.getElementById('filterSource').value;
    const sort = document.getElementById('sortBy').value;

    filteredMonsters = allMonsters.filter(m => {
        if (search && !m.name.toLowerCase().includes(search)) return false;
        if (type && m.type !== type) return false;
        if (cr && m.cr !== cr) return false;
        if (size && !m.size.includes(size)) return false;
        if (source === 'srd' && m.isHomebrew) return false;
        if (source === 'homebrew' && !m.isHomebrew) return false;
        return true;
    });

    // Sort
    filteredMonsters.sort((a, b) => {
        switch (sort) {
            case 'name': return a.name.localeCompare(b.name);
            case 'cr': return crToNum(a.cr) - crToNum(b.cr) || a.name.localeCompare(b.name);
            case 'cr-desc': return crToNum(b.cr) - crToNum(a.cr) || a.name.localeCompare(b.name);
            case 'type': return a.type.localeCompare(b.type) || a.name.localeCompare(b.name);
            case 'hp': return (b.hp || 0) - (a.hp || 0);
            default: return 0;
        }
    });

    document.getElementById('filteredCount').textContent =
        `${filteredMonsters.length} of ${allMonsters.length} monsters`;
    renderMonsterGrid();
}

function renderMonsterGrid() {
    const grid = document.getElementById('monsterGrid');
    if (filteredMonsters.length === 0) {
        grid.innerHTML = '<div class="loading"><p>No monsters match your filters.</p></div>';
        return;
    }

    grid.innerHTML = filteredMonsters.map((m, i) => `
        <div class="monster-card${m.isHomebrew ? ' homebrew-card' : ''}" onclick="selectMonster(${i})" title="Click to view stat block">
            <div class="mc-header">
                <span class="mc-name">${m.name}${m.isHomebrew ? '<span class="hb-badge">HB</span>' : ''}</span>
                <span class="mc-cr">CR ${m.cr}</span>
            </div>
            <div class="mc-meta">${m.size} ${m.type}${m.alignment ? ', ' + m.alignment : ''}</div>
            <div class="mc-stats">
                <span class="mc-stat"><strong>AC</strong> ${m.ac}</span>
                <span class="mc-stat"><strong>HP</strong> ${m.hp}</span>
                <span class="mc-stat"><strong>XP</strong> ${(m.xp || 0).toLocaleString()}</span>
                <span class="mc-stat"><strong>Spd</strong> ${(m.speed || '30 ft.').split(',')[0]}</span>
            </div>
            <button class="mc-add" onclick="event.stopPropagation(); addToEncounter(${i})" title="Add to encounter">+</button>
        </div>
    `).join('');
}

// ===== MONSTER DETAIL =====
function selectMonster(index) {
    selectedMonster = filteredMonsters[index];
    renderStatBlock(selectedMonster);
}

function formatMod(score) {
    const mod = Math.floor((score - 10) / 2);
    return mod >= 0 ? '+' + mod : '' + mod;
}

function viewEncounterMonster(index) {
    selectedMonster = encounter[index].monster;
    renderStatBlock(selectedMonster);
}

function editEncounterMonster(index) {
    const monster = encounter[index].monster;
    replacingEncounterIndex = index;
    // Open homebrew editor as a new monster, pre-filled with a clone of the existing one
    openHomebrewEditor(monster, -1);
    // Set title to indicate editing for encounter
    document.getElementById('hbModalTitle').textContent = 'Edit Encounter Monster';
}

function cloneMonster() {
    if (!selectedMonster) return;
    openHomebrewEditor(selectedMonster);
}

function renderStatBlock(m) {
    selectedMonster = m;
    // Show the Clone button whenever a stat block is displayed
    document.getElementById('cloneBtn').classList.add('visible');
    const area = document.getElementById('statBlockArea');
    const abilities = ['str', 'dex', 'con', 'int', 'wis', 'cha'];

    let html = `
        <div class="stat-block">
            <div class="sb-name">${m.name}</div>
            <div class="sb-meta">${m.size} ${m.type}${m.alignment ? ', ' + m.alignment : ''}</div>
            ${m.isHomebrew ? '<div class="sb-homebrew-label">Homebrew Monster</div>' : ''}
            <div class="sb-combat-line"><strong>AC</strong>&nbsp;${m.ac}</div>
            <div class="sb-combat-line"><strong>HP</strong>&nbsp;${m.hp}${m.hpDice ? ' (' + m.hpDice + ')' : ''}</div>
            <div class="sb-combat-line"><strong>Speed</strong>&nbsp;${m.speed || '30 ft.'}</div>
            <div class="sb-combat-line"><strong>Initiative</strong>&nbsp;${m.initiative != null ? (m.initiative >= 0 ? '+' : '') + m.initiative : formatMod(m.dex)}</div>
            <hr class="sb-divider">
            <div class="ability-scores">
                ${abilities.map(a => `
                    <div>
                        <div class="as-label">${a}</div>
                        <div class="as-score">${m[a] || 10}</div>
                        <div class="as-mod">${formatMod(m[a] || 10)}</div>
                    </div>
                `).join('')}
            </div>
            <hr class="sb-divider">`;

    // Optional info lines
    if (m.skills) html += `<div class="sb-info-line"><strong>Skills</strong> ${m.skills}</div>`;
    if (m.vulnerabilities) html += `<div class="sb-info-line"><strong>Vulnerabilities</strong> ${m.vulnerabilities}</div>`;
    if (m.resistances) html += `<div class="sb-info-line"><strong>Resistances</strong> ${m.resistances}</div>`;
    if (m.immunities) html += `<div class="sb-info-line"><strong>Immunities</strong> ${m.immunities}</div>`;
    if (m.senses) html += `<div class="sb-info-line"><strong>Senses</strong> ${m.senses}</div>`;
    if (m.languages) html += `<div class="sb-info-line"><strong>Languages</strong> ${m.languages}</div>`;
    html += `<div class="sb-info-line"><strong>CR</strong> ${m.cr} (${(m.xp || 0).toLocaleString()} XP)</div>`;

    // Traits
    if (m.traits && m.traits.length > 0) {
        html += `<div class="sb-section-title">Traits</div>`;
        for (const t of m.traits) {
            html += `<div class="sb-trait"><span class="trait-name">${t.name}.</span> ${t.description}</div>`;
        }
    }

    // Actions
    if (m.actions && m.actions.length > 0) {
        html += `<div class="sb-section-title">Actions</div>`;
        for (const a of m.actions) {
            html += `<div class="sb-trait"><span class="trait-name">${a.name}.</span> ${a.description}</div>`;
        }
    }

    // Bonus Actions
    if (m.bonusActions && m.bonusActions.length > 0) {
        html += `<div class="sb-section-title">Bonus Actions</div>`;
        for (const a of m.bonusActions) {
            html += `<div class="sb-trait"><span class="trait-name">${a.name}.</span> ${a.description}</div>`;
        }
    }

    // Reactions
    if (m.reactions && m.reactions.length > 0) {
        html += `<div class="sb-section-title">Reactions</div>`;
        for (const a of m.reactions) {
            html += `<div class="sb-trait"><span class="trait-name">${a.name}.</span> ${a.description}</div>`;
        }
    }

    // Legendary Actions
    if (m.legendaryActions && m.legendaryActions.length > 0) {
        html += `<div class="sb-section-title">Legendary Actions</div>`;
        for (const a of m.legendaryActions) {
            html += `<div class="sb-trait"><span class="trait-name">${a.name}.</span> ${a.description}</div>`;
        }
    }

    html += `<button class="sb-add-btn" onclick="addSelectedToEncounter()">Add to Encounter</button>`;

    // Homebrew action buttons
    if (m.isHomebrew) {
        const hbIdx = homebrewMonsters.indexOf(m);
        html += `<div class="sb-homebrew-actions">
            <button class="btn-edit-hb" onclick="openHomebrewEditor(homebrewMonsters[${hbIdx}], ${hbIdx})">Edit</button>
            <button class="btn-delete-hb" onclick="deleteHomebrewMonster(${hbIdx})">Delete</button>
        </div>`;
    } else {
        html += `<div class="sb-homebrew-actions">
            <button class="btn-save-hb" onclick="openHomebrewEditor(selectedMonster)">Save As Homebrew</button>
        </div>`;
    }

    html += `</div>`;
    area.innerHTML = html;
}

// ===== ENCOUNTER PERSISTENCE =====
const ENCOUNTER_STORAGE_KEY = '2d6kobolds_encounter';

function saveEncounterToStorage() {
    try {
        const serializable = encounter.map(e => ({
            name: e.monster.name,
            count: e.count,
            isHomebrew: !!e.monster.isHomebrew
        }));
        localStorage.setItem(ENCOUNTER_STORAGE_KEY, JSON.stringify(serializable));
    } catch (e) {}
}

function loadEncounterFromStorage() {
    try {
        const saved = localStorage.getItem(ENCOUNTER_STORAGE_KEY);
        if (!saved) return;
        const entries = JSON.parse(saved);
        encounter = [];
        for (const entry of entries) {
            let monster = allMonsters.find(m => m.name === entry.name && !!m.isHomebrew === !!entry.isHomebrew);
            if (!monster) monster = allMonsters.find(m => m.name === entry.name);
            if (monster) {
                encounter.push({ monster, count: entry.count });
            }
        }
        renderEncounterList();
        recalcBudget();
    } catch (e) {}
}

function clearEncounterStorage() {
    localStorage.removeItem(ENCOUNTER_STORAGE_KEY);
}

// ===== SESSION MANAGER =====
const SESSIONS_STORAGE_KEY = '2d6kobolds_sessions';

function loadSessionsData() {
    try {
        const saved = localStorage.getItem(SESSIONS_STORAGE_KEY);
        return saved ? JSON.parse(saved) : { sessions: [] };
    } catch (e) {
        return { sessions: [] };
    }
}

function saveSessionsData(data) {
    localStorage.setItem(SESSIONS_STORAGE_KEY, JSON.stringify(data));
}

function createSession(name) {
    const data = loadSessionsData();
    const session = {
        id: 'session_' + Date.now(),
        name: name,
        encounters: []
    };
    data.sessions.push(session);
    saveSessionsData(data);
    return session;
}

function deleteSession(sessionId) {
    const data = loadSessionsData();
    data.sessions = data.sessions.filter(s => s.id !== sessionId);
    saveSessionsData(data);
}

function saveEncounterToSession(sessionId, encounterName) {
    if (encounter.length === 0) {
        alert('Add some monsters to your encounter first!');
        return;
    }
    const data = loadSessionsData();
    const session = data.sessions.find(s => s.id === sessionId);
    if (!session) return;

    const savedEnc = {
        id: 'enc_' + Date.now(),
        name: encounterName || 'Unnamed Encounter',
        monsters: encounter.map(e => ({
            name: e.monster.name,
            count: e.count,
            isHomebrew: !!e.monster.isHomebrew
        })),
        partySize: parseInt(document.getElementById('partySize').value),
        partyLevel: parseInt(document.getElementById('partyLevel').value),
        difficulty: currentDifficulty
    };
    session.encounters.push(savedEnc);
    saveSessionsData(data);
}

function loadEncounterFromSession(sessionId, encounterId) {
    const data = loadSessionsData();
    const session = data.sessions.find(s => s.id === sessionId);
    if (!session) return;
    const savedEnc = session.encounters.find(e => e.id === encounterId);
    if (!savedEnc) return;

    // Restore encounter
    encounter = [];
    for (const entry of savedEnc.monsters) {
        let monster = allMonsters.find(m => m.name === entry.name && !!m.isHomebrew === !!entry.isHomebrew);
        if (!monster) monster = allMonsters.find(m => m.name === entry.name);
        if (monster) {
            encounter.push({ monster, count: entry.count });
        }
    }

    // Restore party config
    if (savedEnc.partySize) document.getElementById('partySize').value = savedEnc.partySize;
    if (savedEnc.partyLevel) document.getElementById('partyLevel').value = savedEnc.partyLevel;
    if (savedEnc.difficulty) setDifficulty(savedEnc.difficulty);

    renderEncounterList();
    recalcBudget();
    saveEncounterToStorage();
    closeSessionManager();
}

function deleteEncounterFromSession(sessionId, encounterId) {
    const data = loadSessionsData();
    const session = data.sessions.find(s => s.id === sessionId);
    if (!session) return;
    session.encounters = session.encounters.filter(e => e.id !== encounterId);
    saveSessionsData(data);
}

function openSessionManager() {
    document.getElementById('sessionModalOverlay').classList.add('active');
    renderSessionManager();
}

function closeSessionManager() {
    document.getElementById('sessionModalOverlay').classList.remove('active');
}

function openHomebrewManager() {
    document.getElementById('homebrewModalOverlay').classList.add('active');
    renderHomebrewManagerList();
}

function closeHomebrewManager() {
    document.getElementById('homebrewModalOverlay').classList.remove('active');
}

function renderHomebrewManagerList() {
    const container = document.getElementById('homebrewManagerList');
    if (homebrewMonsters.length === 0) {
        container.innerHTML = '<div style="text-align:center;color:var(--ink-light);font-style:italic;font-size:0.85rem;padding:8px 0;">No homebrew monsters yet. Create or import some!</div>';
        return;
    }
    let html = '';
    homebrewMonsters.forEach((m, i) => {
        html += `<div class="hb-manager-entry">
            <span class="hb-manager-name" onclick="closeHomebrewManager();selectedMonster=homebrewMonsters[${i}];renderStatBlock(homebrewMonsters[${i}])">${escapeHtml(m.name)} <span style="font-size:0.7rem;color:var(--ink-light);">CR ${m.cr}</span></span>
            <div class="hb-manager-actions">
                <button class="hb-manager-edit" onclick="closeHomebrewManager();openHomebrewEditor(homebrewMonsters[${i}],${i})" title="Edit">&#9998;</button>
                <button class="hb-manager-delete" onclick="deleteHomebrewMonster(${i});renderHomebrewManagerList();updateHomebrewCount()" title="Delete">&times;</button>
            </div>
        </div>`;
    });
    container.innerHTML = html;
}

function showToast(message, duration) {
    duration = duration || 2500;
    const toast = document.getElementById('toastNotification');
    toast.textContent = message;
    toast.classList.add('visible');
    setTimeout(() => toast.classList.remove('visible'), duration);
}

function toggleSessionGroup(sessionId) {
    const body = document.getElementById('sgBody_' + sessionId);
    body.style.display = body.style.display === 'none' ? 'block' : 'none';
}

function createSessionFromUI() {
    const input = document.getElementById('newSessionName');
    const name = input.value.trim();
    if (!name) {
        alert('Please enter a session name.');
        return;
    }
    createSession(name);
    input.value = '';
    renderSessionManager();
}

function deleteSessionFromUI(sessionId) {
    if (!confirm('Delete this entire session and all its encounters?')) return;
    deleteSession(sessionId);
    renderSessionManager();
}

function saveCurrentEncounterToUI(sessionId) {
    if (encounter.length === 0) {
        alert('Add some monsters to your encounter first!');
        return;
    }
    const input = document.getElementById('encName_' + sessionId);
    const encName = input.value.trim() || 'Unnamed Encounter';
    const data = loadSessionsData();
    const session = data.sessions.find(s => s.id === sessionId);
    const sessionName = session ? session.name : 'session';
    saveEncounterToSession(sessionId, encName);
    closeSessionManager();
    showToast(`"${encName}" saved to ${sessionName}!`);
    if (appSettings.clearOnSave !== false) {
        clearEncounter();
    }
}

function deleteEncounterFromUI(sessionId, encounterId) {
    if (!confirm('Delete this saved encounter?')) return;
    deleteEncounterFromSession(sessionId, encounterId);
    renderSessionManager();
}

function renderSessionManager() {
    const data = loadSessionsData();
    const container = document.getElementById('sessionManagerContent');

    let html = `
        <div class="session-create-row">
            <input type="text" id="newSessionName" placeholder="New session name (e.g., Session 1: Dragon's Lair)">
            <button onclick="createSessionFromUI()">+ New Session</button>
        </div>
    `;

    if (data.sessions.length === 0) {
        html += '<p class="session-empty-msg">No sessions yet. Create one above, then save encounters into it.</p>';
    } else {
        for (const session of data.sessions) {
            const encCount = session.encounters.length;
            html += `
                <div class="session-group">
                    <div class="session-group-header" onclick="toggleSessionGroup('${session.id}')">
                        <span>${escapeHtml(session.name)} (${encCount} encounter${encCount !== 1 ? 's' : ''})</span>
                        <div class="session-group-actions" onclick="event.stopPropagation()">
                            <button onclick="deleteSessionFromUI('${session.id}')" title="Delete Session">&times;</button>
                        </div>
                    </div>
                    <div class="session-group-body" id="sgBody_${session.id}" style="display:none;">
                        <div class="session-save-row">
                            <input type="text" id="encName_${session.id}" placeholder="Encounter name (e.g., Cave Ambush)">
                            <button onclick="saveCurrentEncounterToUI('${session.id}')">Save Current</button>
                        </div>
            `;

            if (session.encounters.length === 0) {
                html += '<p class="session-empty-msg">No encounters saved yet.</p>';
            } else {
                for (const enc of session.encounters) {
                    const monsterSummary = enc.monsters.map(m => `${m.name} x${m.count}`).join(', ');
                    html += `
                        <div class="session-encounter-item">
                            <div class="session-encounter-info">
                                <div class="enc-name">${escapeHtml(enc.name)}</div>
                                <div class="enc-detail">${escapeHtml(monsterSummary)}</div>
                            </div>
                            <div class="session-encounter-actions">
                                <button class="load-enc-btn" onclick="loadEncounterFromSession('${session.id}','${enc.id}')">Load</button>
                                <button class="delete-enc-btn" onclick="deleteEncounterFromUI('${session.id}','${enc.id}')">&times;</button>
                            </div>
                        </div>
                    `;
                }
            }

            html += `</div></div>`;
        }
    }

    container.innerHTML = html;
}

// ===== ENCOUNTER MANAGEMENT =====
function addToEncounter(filteredIndex) {
    const monster = filteredMonsters[filteredIndex];
    addMonsterToEncounter(monster);
}

function addToEncounterByName(name) {
    const monster = allMonsters.find(m => m.name === name);
    if (monster) addMonsterToEncounter(monster);
}

function addMonsterToEncounter(monster) {
    // Use object identity so SRD and homebrew with same name stay separate
    const existing = encounter.find(e => e.monster === monster);
    if (existing) {
        existing.count++;
    } else {
        encounter.push({ monster, count: 1 });
    }
    renderEncounterList();
    recalcBudget();
    saveEncounterToStorage();
}

function addSelectedToEncounter() {
    if (selectedMonster) addMonsterToEncounter(selectedMonster);
}

function removeFromEncounter(index) {
    encounter.splice(index, 1);
    renderEncounterList();
    recalcBudget();
    saveEncounterToStorage();
}

function adjustCount(index, delta) {
    encounter[index].count += delta;
    if (encounter[index].count <= 0) {
        encounter.splice(index, 1);
    }
    renderEncounterList();
    recalcBudget();
    saveEncounterToStorage();
}

function clearEncounter() {
    encounter = [];
    clearEncounterStorage();
    renderEncounterList();
    recalcBudget();
}

function renderEncounterList() {
    const list = document.getElementById('encounterList');
    if (encounter.length === 0) {
        list.innerHTML = '<li style="color: var(--ink-light); font-style: italic; font-size: 0.8rem; justify-content: center;">Click + on a monster to add it</li>';
        return;
    }

    list.innerHTML = encounter.map((entry, i) => {
        const xp = (entry.monster.xp || 0) * entry.count;
        return `
            <li>
                <span class="encounter-monster-info" onclick="viewEncounterMonster(${i})">
                    <strong class="encounter-monster-name">${entry.monster.name}${entry.monster.isHomebrew ? ' <span class="hb-badge">HB</span>' : ''}</strong>
                    <span class="monster-xp-cost">(CR ${entry.monster.cr}, ${xp.toLocaleString()} XP)</span>
                </span>
                <span class="monster-count-controls">
                    <button onclick="adjustCount(${i}, -1)">-</button>
                    <span class="count">${entry.count}</span>
                    <button onclick="adjustCount(${i}, 1)">+</button>
                    <button class="edit-encounter-monster" onclick="editEncounterMonster(${i})" title="Edit">&#9998;</button>
                    <button class="remove-monster" onclick="removeFromEncounter(${i})" title="Remove">&times;</button>
                </span>
            </li>`;
    }).join('');
}

// ===== PRINT INITIATIVE CARDS =====
function showPrintPreview() {
    if (encounter.length === 0) {
        alert('Add some monsters to your encounter first!');
        return;
    }

    const printArea = document.getElementById('printArea');
    const content = document.getElementById('printContent');

    let cards = [];
    for (const entry of encounter) {
        for (let i = 0; i < entry.count; i++) {
            cards.push(renderInitCard(entry.monster, i + 1, entry.count));
        }
    }

    const summaryHtml = appSettings.printSummarySheet ? renderSummarySheet() : '';

    content.innerHTML = `
        <div class="print-paper">
            <div style="text-align:center; margin: 0 0 20px;">
                <h2 style="font-variant: small-caps; color: var(--accent-red);">Initiative Tracker Cards</h2>
                <p style="color: var(--ink-light); font-size: 0.9rem;">
                    Party: ${document.getElementById('partySize').value} players, Level ${document.getElementById('partyLevel').value}
                    | Difficulty: ${currentDifficulty.charAt(0).toUpperCase() + currentDifficulty.slice(1)}
                    | XP Budget: ${document.getElementById('budgetTotal').textContent}
                    | XP Spent: ${document.getElementById('budgetSpent').textContent}
                </p>
                <div class="print-preview-actions">
                    <button class="print-action-btn print-btn-print" onclick="window.print()">&#128424; Print</button>
                    <button class="print-action-btn print-btn-pdf" onclick="window.print()">&#128196; Save as PDF</button>
                </div>
            </div>
            ${summaryHtml}
            <div class="cards-grid">${cards.join('')}</div>
        </div>
    `;

    printArea.classList.add('visible');
}

function closePrintPreview() {
    document.getElementById('printArea').classList.remove('visible');
}

function renderSummarySheet() {
    const partySize = document.getElementById('partySize').value;
    const partyLevel = document.getElementById('partyLevel').value;

    // Build summary rows  one per unique monster
    let rows = '';
    for (const entry of encounter) {
        const m = entry.monster;
        const initBonus = m.initiative != null ? m.initiative : Math.floor(((m.dex || 10) - 10) / 2);
        const initStr = initBonus >= 0 ? '+' + initBonus : '' + initBonus;

        // Best attack summary
        let mainAttack = '';
        if (m.actions && m.actions.length > 0) {
            // Find the first attack action (skip Multiattack)
            const atkAction = m.actions.find(a => a.description && /Attack Roll|Hit:/i.test(a.description) && !/multiattack/i.test(a.name));
            if (atkAction) {
                const hitMatch = atkAction.description.match(/Hit:\s*(\d+)\s*\(([^)]+)\)/);
                const atkMatch = atkAction.description.match(/[+](\d+)/);
                if (hitMatch) {
                    mainAttack = `${atkAction.name}: +${atkMatch ? atkMatch[1] : '?'}, ${hitMatch[1]} (${hitMatch[2]})`;
                } else {
                    mainAttack = atkAction.name;
                }
            }
        }

        // Key saves (highest)
        const saves = ['str','dex','con','int','wis','cha'];
        const highSaves = saves
            .map(s => ({name: s.toUpperCase(), mod: Math.floor(((m[s]||10) - 10)/2)}))
            .filter(s => s.mod >= 2)
            .sort((a,b) => b.mod - a.mod)
            .slice(0, 3)
            .map(s => `${s.name} ${s.mod >= 0 ? '+' : ''}${s.mod}`)
            .join(', ') || '';

        // Special abilities summary (just names)
        const specials = [
            ...(m.traits||[]).map(t => t.name),
            ...(m.bonusActions||[]).map(b => '(B) ' + b.name),
            ...(m.reactions||[]).map(r => '(R) ' + r.name),
        ].filter(n => !/^Amphibious$/i.test(n)).join(', ') || '';

        // Resistances/immunities
        let defenses = [];
        if (m.resistances) defenses.push('Resist: ' + m.resistances);
        if (m.immunities) defenses.push('Immune: ' + m.immunities);
        const defStr = defenses.join('; ') || '';

        rows += `<tr>
            <td><strong>${m.name}</strong></td>
            <td class="num-col">${entry.count}</td>
            <td class="num-col">CR ${m.cr}</td>
            <td class="num-col">${m.ac}</td>
            <td class="num-col">${m.hp}</td>
            <td class="num-col">${initStr}</td>
            <td class="summary-attacks">${mainAttack}</td>
            <td class="summary-attacks">${highSaves}</td>
            <td class="summary-attacks" style="font-size:0.62rem;">${defStr}</td>
            <td class="summary-attacks" style="font-size:0.62rem;">${specials}</td>
        </tr>`;
    }

    const totalXP = encounter.reduce((sum, e) => sum + (e.monster.xp || 0) * e.count, 0);
    const totalCreatures = encounter.reduce((sum, e) => sum + e.count, 0);

    return `<div class="summary-sheet">
        <h2 style="font-variant: small-caps; color: var(--accent-red); text-align: center; margin-bottom: 2px;">Encounter Summary</h2>
        <p style="color: var(--ink-light); font-size: 0.8rem; text-align: center; margin: 0 0 8px;">
            Party: ${partySize} players, Level ${partyLevel}
            | ${totalCreatures} creatures | ${totalXP} XP
        </p>
        <table class="summary-table">
            <thead>
                <tr>
                    <th>Monster</th>
                    <th>Qty</th>
                    <th>CR</th>
                    <th>AC</th>
                    <th>HP</th>
                    <th>Init</th>
                    <th>Main Attack</th>
                    <th>Strong Saves</th>
                    <th>Defenses</th>
                    <th>Key Abilities</th>
                </tr>
            </thead>
            <tbody>${rows}</tbody>
        </table>
    </div>`;
}

function showSummarySheet() {
    if (encounter.length === 0) {
        alert('Add some monsters to your encounter first!');
        return;
    }

    const printArea = document.getElementById('printArea');
    const content = document.getElementById('printContent');

    content.innerHTML = `
        <div class="print-paper">
            <div style="text-align:center; margin: 0 0 20px;">
                <div class="print-preview-actions">
                    <button class="print-action-btn print-btn-print" onclick="window.print()">&#128424; Print</button>
                    <button class="print-action-btn print-btn-pdf" onclick="window.print()">&#128196; Save as PDF</button>
                </div>
            </div>
            ${renderSummarySheet()}
        </div>
    `;

    printArea.classList.add('visible');
}

// ===== PRINT SUMMARY ENGINE =====
function summarizeForPrint(desc, monsterName) {
    if (!desc) return '';
    let s = desc;

    // Remove SRD page number artifacts and normalize curly apostrophes early
    s = s.replace(/\s*\d{2,3}\s+System Reference Document\s+\d+\.\d+/g, '');
    s = s.replace(/\u2019/g, "'");
    s = s.replace(/\u2018/g, "'");

    // ===== CREATURE NAME REMOVAL (always run, even on short text) =====
    if (monsterName) {
        // Build list of name variants: full name + last word for multi-word names
        // e.g. "Adult Black Dragon"  ["Adult Black Dragon", "dragon"]
        const nameVariants = [monsterName];
        const words = monsterName.split(/\s+/);
        if (words.length > 1) {
            nameVariants.push(words[words.length - 1]); // "dragon", "devil", "elemental", etc.
        }
        for (const rawName of nameVariants) {
            const eName = rawName.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            // Possessive: "the aboleth's"  "its" (case insensitive, works everywhere)
            s = s.replace(new RegExp('the ' + eName + "'s ", 'gi'), 'its ');
            // Sentence-start "The aboleth "  "" (remove entirely so verb leads)
            // Match at string start or after ". " or ": "
            s = s.replace(new RegExp('(?:^|(?<=[.:] ))The ' + eName + ' ', 'gi'), '');
            // Before punctuation: "the aboleth."  "it."
            s = s.replace(new RegExp('the ' + eName + '([.,;:])', 'gi'), 'it$1');
            // Mid-sentence: "the aboleth "  "it "
            s = s.replace(new RegExp('the ' + eName + ' ', 'gi'), 'it ');
        }
    }
    // Capitalize sentence starts after creature name removal
    s = s.replace(/(^|[.:] )([a-z])/g, (m, pre, ch) => pre + ch.toUpperCase());

    // If short after name removal, return early
    if (s.length <= 80) return s;

    // "Hit Points"  "HP" early so later patterns can match "HP"
    s = s.replace(/Hit Points/g, 'HP');
    s = s.replace(/Hit Point/g, 'HP');

    // ===== CORE MECHANICAL CONDENSATION =====

    // Saving throws: "X Saving Throw: DC N"  "X Save DC N"
    s = s.replace(/(\w+) Saving Throw: DC (\d+)/g, '$1 Save DC $2');

    // Attack rolls
    s = s.replace(/Melee Attack Roll: \+(\d+), reach (\d+ ft)\./g, 'Melee: +$1, $2.');
    s = s.replace(/Ranged Attack Roll: \+(\d+), range ([\d/]+ ft)\./g, 'Ranged: +$1, $2.');
    s = s.replace(/Melee or Ranged Attack Roll: \+(\d+), reach (\d+ ft)\. or range ([\d/]+ ft)\./g, 'Melee/Ranged: +$1, $2/$3.');

    // Conditions: "has the Charmed condition"  "is Charmed"
    s = s.replace(/has the (\w+) condition/gi, 'is $1');
    s = s.replace(/the (\w+) condition ends on it/gi, '$1 ends');

    // ===== TEMPORAL PHRASES =====
    s = s.replace(/until the end of its next turn/gi, 'until end of next turn');
    s = s.replace(/at the end of each of its turns/gi, 'each turn end');
    s = s.replace(/at the end of every (\d+) minutes/gi, 'every $1 min.');
    s = s.replace(/at the end of its turn/gi, 'at turn end');
    s = s.replace(/at the start of its turn/gi, 'at turn start');
    s = s.replace(/at the start of each of its turns/gi, 'each turn start');
    s = s.replace(/until the start of its next turn/gi, 'until start of next turn');
    s = s.replace(/the start of its next turn/gi, 'start of next turn');

    // ===== SAVE REPETITION =====
    s = s.replace(/ending the effect on itself on a success/gi, 'ends on success');
    s = s.replace(/ending the effect on a success/gi, 'ends on success');
    s = s.replace(/The target repeats the save/g, 'Target repeats save');
    s = s.replace(/the target repeats the save/g, 'target repeats save');
    s = s.replace(/it repeats the save/g, 'repeats save');
    s = s.replace(/the target can repeat the saving throw/gi, 'target repeats save');

    // ===== TARGETING =====
    s = s.replace(/one creature it can see within (\d+) feet/gi, '1 creature within $1 ft.');
    s = s.replace(/one creature within (\d+) feet/gi, '1 creature within $1 ft.');
    s = s.replace(/each creature in a (\d+)-foot-long, (\d+)-foot-?wide Line/gi, 'each creature in $1$2 ft. Line');
    s = s.replace(/each creature in a (\d+)-foot Emanation originating from it/gi, 'each creature in $1 ft. Emanation');
    s = s.replace(/each creature in a (\d+)-foot Emanation/gi, 'each creature in $1 ft. Emanation');
    s = s.replace(/each creature in a (\d+)-foot-radius Sphere centered on a point it can see within (\d+) feet/gi, 'each creature in $1 ft. Sphere within $2 ft.');
    s = s.replace(/each creature that isn't an? \w+ in a (\d+)-foot/gi, 'each non-ally creature in $1-foot');
    s = s.replace(/a creature within (\d+) feet of it/gi, 'creature within $1 ft.');

    // ===== MULTIATTACK =====
    s = s.replace(/[Mm]akes (\w+) (\w[\w ]*?) attacks?\./g, '$1 $2 attacks.');
    s = s.replace(/It can replace one attack with a use of Spellcasting to cast ([^.]+)\./g, 'Can replace 1 attack with $1.');
    s = s.replace(/It can replace one attack with a use of \(A\)\s*([^.]+?)\s+or\s+\(B\)\s*Spellcasting to cast ([^.]+)\./g, 'Can replace 1 attack with $1 or $2.');
    s = s.replace(/and uses either ([^\n.]+) if available/gi, '+ $1 if available');

    // ===== SPELLCASTING =====
    // Full format: "casts one of the following spells, requiring no Material components and using X as the spellcasting ability (spell save DC N, +M to hit):"
    s = s.replace(/[Cc]asts one of the following spells, requiring no Material components and using (\w+) as the spellcasting ability \(spell save DC (\d+), \+(\d+) to hit with spell attacks?\):/g,
        'Casts one spell ($1, save DC $2, +$3 to hit):');
    // Format: "casts one of the following spells, using X as the spellcasting ability (spell save DC N, +M to hit):"
    s = s.replace(/[Cc]asts one of the following spells, using (\w+) as the spellcasting ability \(spell save DC (\d+), \+(\d+) to hit with spell attacks?\):/g,
        'Casts one spell ($1, save DC $2, +$3 to hit):');
    // Format without attack bonus: "... using X as the spellcasting ability (spell save DC N):"
    s = s.replace(/[Cc]asts one of the following spells,(?:\s*requiring no Material components and)? using (\w+) as the spellcasting ability \(spell save DC (\d+)\):/g,
        'Casts one spell ($1, save DC $2):');
    // Fallback: any remaining "(spell save DC N, +M)" or "(spell save DC N)"
    s = s.replace(/\(spell save DC (\d+), \+(\d+) to hit with spell attacks?\)/g, '(save DC $1, +$2 to hit)');
    s = s.replace(/\(spell save DC (\d+)\)/g, '(save DC $1)');
    s = s.replace(/, no Temporary HP gained from the spell, and no Concentration or Temporary HP required to maintain the spell/g, '');
    s = s.replace(/[Uu]ses Spellcasting to cast/g, 'casts');

    // ===== LEGENDARY RESISTANCE =====
    s = s.replace(/If it fails a saving throw, it can choose to succeed instead\./gi, 'Can choose to succeed on a failed save.');

    // ===== MOVEMENT / ACTIONS =====
    s = s.replace(/[Mm]oves up to half its (?:Fly )?Speed/g, 'moves half speed');
    s = s.replace(/ without needing to make an ability check/g, '');
    s = s.replace(/Additionally, Difficult Terrain composed of ([\w\s]+?) doesn't cost it extra movement\./g, 'Ignores $1 difficult terrain.');
    s = s.replace(/can climb difficult surfaces, including along ceilings,/gi, 'can climb any surface,');

    // ===== SIZE REFERENCES =====
    s = s.replace(/If the target is a (\w+ or smaller) creature/g, 'If $1');

    // ===== VERBOSE PHRASES  COMPACT =====
    s = s.replace(/ from one of \w+ \w+/g, '');
    s = s.replace(/After 1 minute, it succeeds automatically\./g, 'Auto-succeeds after 1 min.');
    s = s.replace(/This effect ends for the target if it takes damage or a creature within 5 feet of it takes an action to wake it\./g, 'Ends if target takes damage or is woken.');
    s = s.replace(/can't take this action again until (?:the )?start of (?:its )?next turn/gi, "can't reuse until start of next turn");
    s = s.replace(/Beast or Humanoid form only/g, 'Beast/Humanoid only');

    // Dominate Mind condensation
    s = s.replace(/While Charmed, the target acts as an ally to it and is under its control while within (\d+) feet of it\./gi, 'While Charmed, target is controlled within $1 ft.');
    s = s.replace(/In addition, it and the target can communicate telepathically with each other over any distance\./gi, 'Telepathic link.');
    s = s.replace(/In addition, it and (?:the )?target can communicate telepathically with each other over any distance\./gi, 'Telepathic link.');
    s = s.replace(/Target repeats save whenever it takes damage as well as after every (\d+) hours it spends at least (\d+) mile away from it/gi, 'Target repeats save on damage or after $1h/$2 mi. away');

    // Mucus Cloud condensation
    s = s.replace(/^While underwater, it is surrounded by mucus\. /i, '');
    s = s.replace(/The target is cursed\. Until the curse ends, the target's skin becomes slimy, the target can breathe air and water, and it can't regain HP unless it is underwater\./gi,
        'Cursed: breathes air/water, can\'t regain HP unless underwater.');
    s = s.replace(/While the cursed creature is outside a body of water, the creature takes (\d+) \(([^)]+)\) (\w+) damage at the end of every (\d+) min\. unless moisture is applied to its skin before those minutes have passed\./gi,
        'Outside water: $1 ($2) $3 damage every $4 min. without moisture.');
    s = s.replace(/While the cursed creature is outside a body of water, the creature/gi, 'Outside water, creature');
    s = s.replace(/unless moisture is applied to its skin before those minutes have passed/gi, 'without moisture');

    // Misty Escape condensation
    s = s.replace(/If it drops to 0 HP outside its resting place, it uses Shape-Shift to become mist \(no action required\)\./gi, 'At 0 HP outside resting place, becomes mist (no action).');
    s = s.replace(/If it can't use Shape-?Shift, it is destroyed\./gi, 'Destroyed if can\'t shift.');
    s = s.replace(/While it has 0 HP in mist form, it can't return to its \w+ form, and it must reach its resting place within (\d+) hours or be destroyed\./gi, 'Must reach resting place within $1h or destroyed.');
    s = s.replace(/Once in its resting place, it returns to its \w+ form and is Paralyzed until it regains any HP, and it regains 1 HP after spending 1 hour there\./gi, 'At resting place: Paralyzed until regains HP (1 HP after 1h).');

    // Plane of existence
    s = s.replace(/or is on a different plane of existence from the target/gi, 'or on different plane');
    s = s.replace(/on a different plane of existence/gi, 'on different plane');

    // "if the target is a Humanoid and is reduced to 0 HP by this action"
    s = s.replace(/if the target is a (\w+) and is reduced to 0 HP by this action/gi, 'if target is $1 reduced to 0 HP');

    // "within X feet of it"  "within X ft."
    s = s.replace(/within (\d+) feet of it/gi, 'within $1 ft.');
    s = s.replace(/within (\d+) feet/gi, 'within $1 ft.');

    // General "the target"  "target" (after all specific patterns above)
    s = s.replace(/[Tt]he target /g, 'Target ');

    // General cleanup
    s = s.replace(/  +/g, ' ').trim();
    s = s.replace(/\.\./g, '.');
    s = s.replace(/,\s*\./g, '.');

    return s;
}

function rollInitiative(m) {
    const bonus = m.initiative != null ? m.initiative : Math.floor(((m.dex || 10) - 10) / 2);
    const roll = Math.floor(Math.random() * 20) + 1 + bonus;
    return roll;
}

function renderInitCard(m, num, total) {
    const abilities = ['str', 'dex', 'con', 'int', 'wis', 'cha'];
    const nameLabel = total > 1 ? `${m.name} #${num}` : m.name;

    function renderCardSection(title, entries) {
        if (!entries || entries.length === 0) return '';
        let html = `<div class="card-actions-section"><div class="card-section-title">${title}</div>`;
        for (const e of entries) {
            html += `<div class="card-action-item"><span class="action-name">${e.name}.</span> ${summarizeForPrint(e.description || '', m.name)}</div>`;
        }
        html += `</div>`;
        return html;
    }

    const traitsHtml = renderCardSection('Traits', m.traits);
    const actionsHtml = renderCardSection('Actions', m.actions);
    const bonusHtml = renderCardSection('Bonus Actions', m.bonusActions);
    const reactionsHtml = renderCardSection('Reactions', m.reactions);
    const legendaryHtml = renderCardSection('Legendary Actions', m.legendaryActions);

    // Special properties for the card
    let specials = [];
    if (m.resistances) specials.push(`<span class="card-special-line"><strong>Resist:</strong> ${m.resistances}</span>`);
    if (m.immunities) specials.push(`<span class="card-special-line"><strong>Immune:</strong> ${m.immunities}</span>`);
    if (m.vulnerabilities) specials.push(`<span class="card-special-line"><strong>Vuln:</strong> ${m.vulnerabilities}</span>`);

    // Determine number of HP tally boxes (roughly 1 per 20hp, min 5, max 15)
    const hpBoxCount = Math.min(15, Math.max(5, Math.ceil((m.hp || 10) / 20)));

    return `
        <div class="init-card">
            <div class="init-card-header">
                <span class="card-name">${nameLabel}</span>
                <span class="card-cr">CR ${m.cr}</span>
            </div>
            <div class="init-card-body">
                <div class="card-meta">${m.size} ${m.type}${m.alignment ? ', ' + m.alignment : ''}</div>
                <div class="card-combat-stats">
                    <div class="card-combat-stat">
                        <div class="stat-label">AC</div>
                        <div class="stat-value">${m.ac}</div>
                    </div>
                    <div class="card-combat-stat">
                        <div class="stat-label">HP</div>
                        <div class="stat-value">${m.hp}</div>
                    </div>
                    <div class="card-combat-stat">
                        <div class="stat-label">Speed</div>
                        <div class="stat-value" style="font-size:0.7rem;">${(m.speed || '30 ft.').split(',')[0]}</div>
                    </div>
                </div>
                <div class="card-abilities">
                    ${abilities.map(a => `
                        <div>
                            <div class="ab-label">${a}</div>
                            <div class="ab-val">${m[a] || 10} (${formatMod(m[a] || 10)})</div>
                        </div>
                    `).join('')}
                </div>
                ${specials.join('')}
                ${traitsHtml}
                ${actionsHtml}
                ${bonusHtml}
                ${reactionsHtml}
                ${legendaryHtml}
            </div>
            <div class="init-card-footer">
                <div class="init-track">
                    <span class="init-label">Init</span>
                    <div class="init-box">${appSettings.prerollInitiative ? rollInitiative(m) : ''}</div>
                </div>
                <div class="hp-tracker">
                    <span class="hp-label">HP</span>
                    <div class="hp-boxes">
                        ${Array(hpBoxCount).fill('<div class="hp-box"></div>').join('')}
                    </div>
                </div>
            </div>
        </div>`;
}

// Keyboard shortcuts
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        if (document.getElementById('hbModalOverlay').classList.contains('active')) {
            closeHomebrewEditor();
        } else if (document.getElementById('homebrewModalOverlay').classList.contains('active')) {
            closeHomebrewManager();
        } else if (document.getElementById('sessionModalOverlay').classList.contains('active')) {
            closeSessionManager();
        } else if (document.getElementById('settingsModalOverlay').classList.contains('active')) {
            closeSettingsModal();
        } else if (document.getElementById('aboutModalOverlay').classList.contains('active')) {
            closeAboutModal();
        } else {
            closePrintPreview();
        }
    }
});
</script>

<!-- Toast notification -->
<div class="toast-notification" id="toastNotification"></div>

<!-- Monster data will be loaded from monsters.json or embedded below -->
<script src="monsters.js"></script>
</body>
</html>
